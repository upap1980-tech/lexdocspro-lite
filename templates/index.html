<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LexDocsPro ENTERPRISE v3.2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --primary: #0b57d0;
            --primary-soft: #3b82f6;
            --dark: #0f2f63;
            --sidebar-width: 280px;
            --success: #15803d;
            --warning: #b45309;
            --danger: #b91c1c;
            --info: #0f766e;
            --surface: #ffffff;
            --surface-2: #f8fafc;
            --ink: #0f172a;
            --ink-soft: #475569;
            --border: #dbe3ee;
            --shadow-sm: 0 6px 14px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 14px 34px rgba(15, 23, 42, 0.12);
            --radius: 14px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background:
                radial-gradient(circle at 15% -10%, rgba(59,130,246,0.08), transparent 40%),
                radial-gradient(circle at 85% 0%, rgba(15,118,110,0.08), transparent 35%),
                #f3f6fb;
            display: flex;
            overflow-x: hidden;
            color: var(--ink);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* SIDEBAR ENTERPRISE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #0b3a7a 0%, #0d2855 100%);
            color: white;
            position: fixed;
            transform: translateX(0);
            transition: transform 0.25s ease;
            overflow-y: auto;
            box-shadow: 8px 0 24px rgba(2, 6, 23, 0.3);
            z-index: 1000;
            border-right: 1px solid rgba(255,255,255,0.12);
        }
        
        .sidebar-header {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, rgba(7,22,47,0.98), rgba(7,22,47,0.9));
            backdrop-filter: blur(3px);
            z-index: 2;
        }
        
        .sidebar-header h2 {
            margin: 0;
            letter-spacing: 0.7px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .sidebar-header small {
            opacity: 0.78;
            display: block;
            margin-top: 5px;
            letter-spacing: 0.3px;
        }
        
        .nav-group {
            padding: 10px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 22px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: 0.22s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            border-radius: 0 10px 10px 0;
            margin: 2px 8px 2px 0;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background: rgba(255,255,255,0.18);
            color: white;
            border-left-color: #7dd3fc;
            transform: translateX(1px);
        }
        
        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        .badge {
            background: #dc2626;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: auto;
            font-weight: bold;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* CONTENIDO PRINCIPAL */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            min-height: 100vh;
            padding: 34px 38px;
        }

        body.sidebar-hidden .sidebar {
            transform: translateX(-105%);
        }

        body.sidebar-hidden .main-content {
            margin-left: 0;
            width: 100%;
        }
        
        .main-content h1 {
            color: var(--ink);
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* KPI CARDS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: linear-gradient(160deg, #f8fbff 0%, #eef4ff 100%);
            padding: 25px;
            border-radius: var(--radius);
            border-bottom: 4px solid var(--primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .kpi-card h3 {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0f172a;
            display: block;
        }
        
        .kpi-card.success { border-bottom-color: var(--success); background: linear-gradient(160deg, #ecfdf3 0%, #dcfce7 100%); }
        .kpi-card.warning { border-bottom-color: var(--warning); background: linear-gradient(160deg, #fff7ed 0%, #ffedd5 100%); }
        .kpi-card.danger { border-bottom-color: var(--danger); background: linear-gradient(160deg, #fef2f2 0%, #fee2e2 100%); }
        .kpi-card.info { border-bottom-color: var(--info); background: linear-gradient(160deg, #eef2ff 0%, #e0e7ff 100%); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* GRÃFICOS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-card {
            background: var(--surface);
            padding: 25px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.1rem;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* MÃ“DULOS PLACEHOLDER */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .module-placeholder {
            background: var(--surface);
            padding: 60px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .module-placeholder h2 {
            color: #334155;
            margin-bottom: 15px;
        }
        
        .module-placeholder p {
            color: #64748b;
            font-size: 1.1rem;
        }

        /* Mejoras enterprise transversales */
        button, .btn-icon {
            transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
        }

        button:hover, .btn-icon:hover {
            transform: translateY(-1px);
        }

        input, select, textarea {
            border: 1px solid var(--border) !important;
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.03);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #60a5fa !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.22);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* RESPONSIVE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar-header h2,
            .sidebar-header small,
            .nav-item span {
                display: none;
            }
            
            .main-content {
                margin-left: 80px;
                width: calc(100% - 80px);
                padding: 18px;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- SIDEBAR -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>LexDocsPro</h2>
            <small>ENTERPRISE v3.2</small>
        </div>
        
        <nav class="nav-group">
            <div class="nav-item active" onclick="showTab('dashboard')">
                <i>ğŸ“Š</i> <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showTab('autoprocesos')">
                <i>ğŸ¤–</i> <span>Auto-Procesos</span>
            </div>
            <div class="nav-item" onclick="showTab('ia-cascade')">
                <i>ğŸ”</i> <span>IA Cascade</span>
            </div>
            <div class="nav-item" onclick="showTab('pdf-preview')">
                <i>ğŸ“„</i> <span>PDF Preview</span>
            </div>
            <div class="nav-item" onclick="showTab('email-alerts')">
                <i>ğŸ“§</i> <span>Email Alerts</span>
            </div>
            <div class="nav-item" onclick="showTab('firma-digital')">
                <i>âœï¸</i> <span>Firma Digital</span>
            </div>
            <div class="nav-item" onclick="showTab('banking')">
                <i>ğŸ¦</i> <span>Banking (11 bancos)</span>
            </div>
            <div class="nav-item" onclick="showTab('usuarios')">
                <i>ğŸ‘¥</i> <span>Usuarios</span>
            </div>
            <div class="nav-item" onclick="showTab('pwa')">
                <i>ğŸ“±</i> <span>PWA Status</span>
            </div>
            <div class="nav-item" onclick="showTab('ia-agent')">
                <i>ğŸ§ </i> <span>IA Agent</span>
            </div>
            <div class="nav-item" onclick="showTab('analytics')">
                <i>ğŸ“ˆ</i> <span>Analytics</span>
            </div>
            <div class="nav-item" onclick="showTab('expedientes')">
                <i>ğŸ“</i> <span>Expedientes</span>
            </div>
            <div class="nav-item" onclick="showTab('lexnet')">
                <i>âš–ï¸</i> <span>LexNET</span>
                <span class="badge">2</span>
            </div>
            <div class="nav-item" onclick="showTab('config')">
                <i>âš™ï¸</i> <span>ConfiguraciÃ³n</span>
            </div>
            <div class="nav-item" onclick="showTab('deploy')">
                <i>ğŸš€</i> <span>Deploy Status</span>
            </div>
        </nav>
    </aside>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- CONTENIDO PRINCIPAL -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main class="main-content">
        <div id="first-run-overlay" style="position:fixed; inset:0; background:rgba(15,23,42,0.75); display:none; align-items:center; justify-content:center; z-index:9999;">
            <div style="background:#fff; width:min(720px, 92vw); max-height:88vh; overflow:auto; border-radius:16px; padding:20px 24px; box-shadow:0 10px 40px rgba(0,0,0,0.35);">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <h2 style="margin:0;">Bienvenido a LexDocsPro LITE</h2>
                    <button onclick="closeFirstRun()" style="border:none; background:#e2e8f0; padding:6px 10px; border-radius:8px; cursor:pointer;">Cerrar</button>
                </div>
                <p style="color:#475569;">GuÃ­a rÃ¡pida para dejar todo funcionando en minutos.</p>
                <ol style="line-height:1.8; color:#0f172a; padding-left:18px;">
                    <li>Configura IA (Ollama o API keys) en <strong>ConfiguraciÃ³n</strong>.</li>
                    <li>Activa Email Alerts con SMTP y prueba el envÃ­o.</li>
                    <li>Sube un PDF en <strong>Documentos E2E</strong> y ejecuta Smart Analyze.</li>
                    <li>Confirma guardado y firma digital si hay certificado.</li>
                    <li>Valida LexNET con un XML/PDF de prueba.</li>
                </ol>
                <div style="margin-top:12px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px;">
                    QA diaria: <code>docs/QA_RAPIDA_10_PASOS.md</code>
                </div>
                <div style="margin-top:16px; display:flex; gap:8px;">
                    <button onclick="openQA()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">Ver QA RÃ¡pida</button>
                    <button onclick="markFirstRunDone()" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">No volver a mostrar</button>
                </div>
            </div>
        </div>
        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
        <!-- DASHBOARD -->
        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
        <section id="dashboard" class="section active">
            <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center; justify-content:space-between;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="toggleSidebar()" style="padding:8px 12px; background:#0f172a; color:#fff; border:none; border-radius:8px; cursor:pointer;">â˜°</button>
                    <h1 style="margin:0; color: #333;">Dashboard General</h1>
                    <span style="background:#e0f2fe; color:#0ea5e9; padding:4px 10px; border-radius:999px; font-weight:700; font-size:0.95rem;">v3.2.1</span>
                </div>
                <button onclick="goBack()" style="padding:8px 12px; background:#e2e8f0; border:none; border-radius:8px; cursor:pointer; color:#0f172a;">â† Volver</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">
                <button id="btn-dash-refresh" onclick="refreshDashboard()" style="padding:8px 14px; background:#0ea5e9; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Actualizar</button>
                <button onclick="openDashboardModal()" style="padding:8px 14px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ” Ver Detalle</button>
                <button onclick="uiDashboardExportPDF()" style="padding:8px 14px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“„ Exportar PDF</button>
                <span id="dash-last-updated" style="color:#475569; font-size:0.9rem;">â€”</span>
            </div>
            <div id="dashboard-statusbar" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px;"></div>
            <div id="dashboard-detail" style="background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:14px; margin-bottom:18px; color:#334155;">
                Cargando detalle...
            </div>
            
            <!-- KPIs -->
            <div class="kpi-grid" style="grid-template-columns: repeat(4, minmax(200px, 1fr));">
                <div class="kpi-card success" onclick="goToDashboardCard('hoy')" style="cursor:pointer;">
                    <h3>Procesos Hoy</h3>
                    <span class="kpi-value" id="val-hoy">0</span>
                </div>
                <div class="kpi-card info" onclick="goToDashboardCard('revision')" style="cursor:pointer;">
                    <h3>En RevisiÃ³n</h3>
                    <span class="kpi-value" id="val-rev">0</span>
                </div>
                <div class="kpi-card warning" onclick="goToDashboardCard('errores')" style="cursor:pointer;">
                    <h3>Errores</h3>
                    <span class="kpi-value" id="val-err">0</span>
                </div>
                <div class="kpi-card danger" onclick="goToDashboardCard('alertas')" style="cursor:pointer;">
                    <h3>Alertas</h3>
                    <span class="kpi-value" id="val-ale">0</span>
                </div>
            </div>
            
            <!-- GrÃ¡ficos -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Documentos Procesados (Ãšltimos 7 dÃ­as)</h3>
                    <canvas id="chart-docs"></canvas>
                </div>
                <div class="chart-card">
                    <h3>DistribuciÃ³n por Tipo</h3>
                    <canvas id="chart-tipos"></canvas>
                </div>
            </div>
        </section>

        <!-- BotÃ³n volver global (float) -->
        <div style="position:fixed; top:14px; right:14px; z-index:1800; display:flex; gap:8px;">
            <button onclick="toggleSidebar()" style="padding:10px 12px; background:#0f172a; color:#fff; border:none; border-radius:10px; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,0.15);">â˜°</button>
            <button onclick="goBack()" id="btn-global-back" style="padding:10px 14px; background:#0f172a; color:#fff; border:none; border-radius:10px; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,0.15);">â† Volver</button>
        </div>

        <!-- Modal detalle dashboard -->
        <div id="dashboard-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:2000; align-items:center; justify-content:center;">
            <div style="background:white; width:90%; max-width:1100px; max-height:90vh; overflow-y:auto; border-radius:12px; padding:18px; box-shadow:0 20px 50px rgba(0,0,0,0.2);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3 style="margin:0;">Detalle operativo</h3>
                    <button onclick="closeDashboardModal()" style="border:none; background:#e2e8f0; padding:6px 10px; border-radius:6px; cursor:pointer;">Cerrar</button>
                </div>
                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
                    <button onclick="reloadModalData()" style="padding:8px 12px; background:#0ea5e9; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Actualizar</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <h4 style="margin:0;">Ãšltimos documentos</h4>
                            <div>
                                <button onclick="changeDocsPage(-1)" style="padding:4px 8px;">â—€</button>
                                <button onclick="changeDocsPage(1)" style="padding:4px 8px;">â–¶</button>
                            </div>
                        </div>
                        <table style="width:100%; border-collapse:collapse;" id="table-docs">
                            <thead>
                                <tr style="text-align:left; border-bottom:1px solid #e2e8f0;">
                                    <th style="padding:6px;">Archivo</th>
                                    <th style="padding:6px;">Fecha</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <h4 style="margin:0;">Alertas LexNET</h4>
                            <div>
                                <button onclick="changeAlertsPage(-1)" style="padding:4px 8px;">â—€</button>
                                <button onclick="changeAlertsPage(1)" style="padding:4px 8px;">â–¶</button>
                            </div>
                        </div>
                        <table style="width:100%; border-collapse:collapse;" id="table-alerts">
                            <thead>
                                <tr style="text-align:left; border-bottom:1px solid #e2e8f0;">
                                    <th style="padding:6px;">TÃ­tulo</th>
                                    <th style="padding:6px;">Fecha</th>
                                    <th style="padding:6px;">Urgencia</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
        <!-- OTROS MÃ“DULOS (PLACEHOLDERS) -->
        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
                        <section id="autoprocesos" class="section">
            <h1 style="margin-bottom: 30px; color: #333;">ğŸ¤– Auto-Procesos</h1>
            
            <!-- Control Panel -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Panel de Control</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button onclick="startAutoProcessor()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        â–¶ï¸ INICIAR
                    </button>
                    <button onclick="stopAutoProcessor()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        â¸ï¸ DETENER
                    </button>
                    <button onclick="scanFiles()" style="padding: 10px 20px; background: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        ğŸ” ESCANEAR
                    </button>
                    <button onclick="resetAutoProcessor()" style="padding: 10px 20px; background: #fd7e14; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        â™»ï¸ RESET
                    </button>
                    <button onclick="loadAutoProcessorStatus()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        ğŸ”„ ACTUALIZAR
                    </button>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
                    <input id="auto-doc-id" type="number" placeholder="doc_id legacy" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; width:120px;">
                    <button onclick="uiAutoLegacyDocumento()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“„ Ver doc</button>
                    <button onclick="uiAutoLegacyAprobar()" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">âœ… Aprobar</button>
                    <button onclick="uiAutoLegacyRechazar()" style="padding:8px 12px; background:#dc2626; color:#fff; border:none; border-radius:6px; cursor:pointer;">âŒ Rechazar</button>
                    <button onclick="uiAutoLegacyPdf()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“‘ PDF</button>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
                    <button onclick="uiAutoLegacyStats()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“Š Stats legacy</button>
                    <button onclick="uiAutoLegacyQueue()" style="padding:8px 12px; background:#475569; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“¥ Cola revisiÃ³n</button>
                    <button onclick="uiAutoLegacyProcessedToday()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“… Procesados hoy</button>
                    <button onclick="uiAutoLegacyClientes()" style="padding:8px 12px; background:#1e40af; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ‘¥ Clientes</button>
                    <button onclick="uiLegacyLogs()" style="padding:8px 12px; background:#0891b2; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“œ Logs legacy</button>
                    <button onclick="uiLegacyToggle()" style="padding:8px 12px; background:#b45309; color:#fff; border:none; border-radius:6px; cursor:pointer;">â¯ï¸ Toggle watchdog</button>
                    <button onclick="uiLegacyWatchdog()" style="padding:8px 12px; background:#be123c; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ©º Watchdog</button>
                </div>
                
                <div id="auto-status" style="padding: 15px; background: #f8f9fa; border-radius: 6px; font-family: monospace;">
                    <p>ğŸ”„ Cargando estado...</p>
                </div>
                <pre id="auto-legacy-output" style="margin-top:10px; background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:180px; overflow:auto;">Auto legacy output...</pre>
            </div>
            
            <!-- EstadÃ­sticas -->
            <div class="kpi-grid" style="grid-template-columns: repeat(4, minmax(220px, 1fr));">
                <div class="kpi-card success">
                    <h3>Procesados</h3>
                    <span class="kpi-value" id="auto-processed">0</span>
                </div>
                <div class="kpi-card warning">
                    <h3>En Cola</h3>
                    <span class="kpi-value" id="auto-pending">0</span>
                </div>
                <div class="kpi-card danger">
                    <h3>Errores</h3>
                    <span class="kpi-value" id="auto-errors">0</span>
                </div>
                <div class="kpi-card info">
                    <h3>Estado</h3>
                    <span class="kpi-value" id="auto-running" style="font-size: 1.5rem;">â¸ï¸</span>
                </div>
            </div>
            
            <!-- Cola de Procesamiento -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">Cola de Procesamiento</h3>
                <div id="processing-queue" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #999; text-align: center; padding: 40px;">Cargando...</p>
                </div>
            </div>

            <!-- Historial de Procesamiento -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap:12px; margin-bottom: 15px; flex-wrap:wrap;">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <h3 style="margin:0;">Historial de Procesamiento</h3>
                        <label style="font-size:0.9rem; color:#475569;">Estado:
                            <select id="log-filter-status" onchange="applyProcessingLogFilter()" style="margin-left:6px; padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                                <option value="ALL">Todos</option>
                                <option value="SUCCESS">Success</option>
                                <option value="ERROR">Error</option>
                            </select>
                        </label>
                        <input id="log-filter-search" oninput="applyProcessingLogFilter()" placeholder="Buscar archivo..." style="padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px; min-width:200px;">
                        <input id="log-filter-from" type="date" onchange="applyProcessingLogFilter()" style="padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                        <input id="log-filter-to" type="date" onchange="applyProcessingLogFilter()" style="padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                    </div>
                    <button onclick="loadProcessingLog()" style="padding: 8px 15px; background: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ”„ Actualizar
                    </button>
                </div>
                <div id="processing-log" style="overflow-x: auto;">
                    <p style="color: #999; text-align: center; padding: 40px;">Cargando historial...</p>
                </div>
            </div>
        </section>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             IA CASCADE SECTION v3.0 - Multi-Provider Dashboard
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <section id="ia-cascade" class="section">
            <h1 style="margin-bottom: 30px; color: #333;">ğŸ¤– IA Cascade - Multi-Provider Dashboard</h1>
            
            <!-- Stats Globales -->
            <div class="cascade-global-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 2em; margin: 0 0 10px 0;" id="cascade-total-calls">0</h3>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Total Llamadas</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 2em; margin: 0 0 10px 0;" id="cascade-success-calls">0</h3>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Ã‰xitos</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 2em; margin: 0 0 10px 0;" id="cascade-failed-calls">0</h3>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Fallos</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f6ad55 0%, #dd6b20 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 2em; margin: 0 0 10px 0;" id="cascade-avg-uptime">0%</h3>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Uptime Promedio</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #48bb78 0%, #2f855a 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 2em; margin: 0 0 10px 0;" id="cascade-enabled-providers">0</h3>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Providers Activos</p>
                </div>
            </div>
            <div id="cascade-health" style="margin-bottom: 20px; padding: 10px 14px; border-radius: 8px; background: #eef2ff; color: #1e3a8a;">
                Estado IA Cascade: comprobando...
            </div>
            
            <!-- Tabla de Providers -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px;">ğŸ“Š Providers Configurados</h3>
                
                <div style="overflow-x: auto;">
                    <table id="providers-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #2c3e50; color: white;">
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Prioridad</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Provider</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Modelo</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Estado</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Llamadas</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Ã‰xitos</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Fallos</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Tiempo Promedio</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Uptime</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">API Key</th>
                                <th style="padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9em;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="providers-tbody">
                            <tr>
                                <td colspan="11" style="padding: 40px; text-align: center; color: #999;">
                                    ğŸ”„ Cargando providers...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Test Area -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px;">ğŸ§ª Test de Providers</h3>
                
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px;">
                    <label style="display: flex; flex-direction: column; gap: 8px;">
                        <strong>Provider:</strong>
                        <select id="test-provider" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em;">
                            <option value="cascade">ğŸ”„ Cascade AutomÃ¡tico (Fallback)</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="groq">Groq Cloud</option>
                            <option value="perplexity">Perplexity AI</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </label>
                    
                    <label style="display: flex; flex-direction: column; gap: 8px;">
                        <strong>Temperature: <span id="temp-value">0.3</span></strong>
                        <input type="range" id="test-temperature" min="0" max="1" step="0.1" value="0.3" style="padding: 10px;">
                    </label>
                </div>
                
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                    <strong>Prompt de Prueba:</strong>
                    <textarea id="test-prompt-input" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.95em; resize: vertical;" placeholder="Escribe tu pregunta aquÃ­...">Â¿QuÃ© es el artÃ­culo 133 de la LEC?</textarea>
                </label>
                
                <button id="btn-test-cascade" onclick="testIACascade()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 1em; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                    ğŸš€ Ejecutar Test
                </button>
                
                <!-- Resultado -->
                <div id="test-result" style="display: none; margin-top: 20px; padding: 20px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 8px; animation: fadeIn 0.3s;">
                    <h4 style="margin-top: 0;">ğŸ“„ Resultado:</h4>
                    <div class="result-meta" style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; font-size: 0.9em; color: #4a5568;">
                        <span>ğŸ¤– Provider: <strong id="result-provider"></strong></span>
                        <span>â±ï¸ Tiempo: <strong id="result-time"></strong></span>
                        <span>ğŸ“Š Tokens: <strong id="result-tokens"></strong></span>
                    </div>
                    <div class="result-content">
                        <pre id="result-text" style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"></pre>
                    </div>
                </div>
                
                <!-- Error -->
                <div id="test-error" style="display: none; margin-top: 20px; padding: 20px; background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; animation: fadeIn 0.3s;">
                    <h4 style="margin-top: 0; color: #e53e3e;">âŒ Error:</h4>
                    <pre id="error-text" style="background: #2d3748; color: #fc8181; padding: 15px; border-radius: 6px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"></pre>
                </div>
            </div>
            
            <!-- Botones de GestiÃ³n -->
            <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                <button onclick="refreshCascadeStats()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s; font-size: 0.95em;">
                    ğŸ”„ Refrescar Stats
                </button>
                <button onclick="resetCascadeStats()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s; font-size: 0.95em;">
                    ğŸ—‘ï¸ Resetear Stats
                </button>
                <button onclick="exportCascadeStats()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s; font-size: 0.95em;">
                    ğŸ“¥ Exportar Stats (JSON)
                </button>
            </div>
        </section>

        <!-- Modal para Actualizar API Keys -->
        <div id="api-key-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
            <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                <h3 style="margin-top: 0;">ğŸ”‘ Actualizar API Key</h3>
                <p style="margin-bottom: 20px;">Provider: <strong id="modal-provider-name"></strong></p>
                
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                    <strong>API Key:</strong>
                    <input type="password" id="modal-api-key-input" placeholder="Ingresa la API key" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.95em;">
                </label>
                
                <div class="modal-buttons" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="saveAPIKey()" style="padding: 10px 20px; border: none; border-radius: 6px; background: #48bb78; color: white; cursor: pointer; font-size: 0.95em; font-weight: 600;">
                        ğŸ’¾ Guardar
                    </button>
                    <button onclick="closeAPIKeyModal()" style="padding: 10px 20px; border: none; border-radius: 6px; background: #e53e3e; color: white; cursor: pointer; font-size: 0.95em; font-weight: 600;">
                        âŒ Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Estilos adicionales para animaciones -->
        <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #providers-table tbody tr:hover {
            background: #f0f8ff !important;
        }

        #providers-table {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        #providers-table th {
            background: linear-gradient(180deg, #1e293b, #0f172a) !important;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        #providers-table td {
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }

        #providers-table tbody tr.provider-enabled {
            background: #f8fff9;
        }

        #providers-table tbody tr.provider-disabled {
            background: #fff8f8;
            opacity: 0.7;
        }

        #ia-cascade .stat-card {
            border: 1px solid rgba(255,255,255,0.22);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        #ia-cascade .stat-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255,255,255,0.12), transparent 45%);
            pointer-events: none;
        }

        #ia-cascade .result-content pre,
        #ia-cascade #error-text {
            border: 1px solid rgba(148,163,184,0.35);
        }

        #ia-cascade .modal-content {
            border: 1px solid var(--border);
            box-shadow: 0 22px 56px rgba(15, 23, 42, 0.28);
        }

        /* Pasada visual v2 - IA Cascade (micro-ajustes) */
        #ia-cascade > h1 {
            margin-bottom: 24px !important;
            font-size: clamp(1.5rem, 2vw, 2rem);
            letter-spacing: -0.02em;
        }

        #ia-cascade h3 {
            color: #0f172a;
            letter-spacing: -0.01em;
        }

        #ia-cascade .cascade-global-stats {
            margin-bottom: 24px !important;
            gap: 16px !important;
        }

        #ia-cascade .stat-card h3 {
            font-size: 2.1em !important;
            margin-bottom: 8px !important;
            line-height: 1;
        }

        #ia-cascade .stat-card p {
            font-size: 0.84em !important;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        #ia-cascade .result-meta span {
            background: #e2e8f0;
            color: #1e293b;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.8em !important;
            font-weight: 600;
        }

        #ia-cascade #test-result {
            border-color: #86efac !important;
            box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.08);
        }

        #ia-cascade #test-error {
            border-color: #fca5a5 !important;
            box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.08);
        }

        #ia-cascade #providers-table td,
        #ia-cascade #providers-table th {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 0.9em;
            vertical-align: middle;
        }

        #ia-cascade .status-badge {
            font-size: 0.78em;
            letter-spacing: 0.01em;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        #ia-cascade .btn-icon {
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        #ia-cascade .btn-icon:hover {
            background: #eef2ff;
            border-color: #bfdbfe;
        }

        #ia-cascade #btn-test-cascade {
            box-shadow: 0 8px 22px rgba(59, 130, 246, 0.25);
            letter-spacing: 0.01em;
        }

        #ia-cascade #btn-test-cascade:disabled {
            box-shadow: none;
        }

        #ia-cascade .modal-content input[type="password"] {
            font-size: 0.9rem !important;
            letter-spacing: 0.02em;
        }

        #ia-cascade .modal-buttons button {
            min-width: 120px;
        }

        #ia-cascade .uptime-bar {
            border: 1px solid #dbe3ee;
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.06);
        }

        #ia-cascade .uptime-fill {
            background: linear-gradient(90deg, #16a34a 0%, #65a30d 100%);
        }

        #btn-test-cascade:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #btn-test-cascade:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal.visible {
            display: flex !important;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Uptime Bar */
        .uptime-bar {
            width: 100%;
            height: 24px;
            background: #ecf0f1;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .uptime-fill {
            height: 100%;
            background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
            transition: width 0.3s ease;
        }

        .uptime-bar span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        /* Actions Cell */
        .actions-cell {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-icon:hover {
            background: rgba(0,0,0,0.05);
        }
        </style>




        <section id="pdf-preview" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ“„ OCR / PDF / Files</h2>
                <div id="files-roots" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="files-path" value="PROCESADOS_LEXDOCS" placeholder="Ruta (p.ej. PROCESADOS_LEXDOCS o EXPEDIENTES_LEXDOCS/subcarpeta)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:260px;">
                    <button onclick="uiLoadFiles()" style="padding:8px 12px; background:#0284c7; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“‚ Cargar</button>
                </div>
                <div id="files-list" style="max-height:180px; overflow:auto; border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-bottom:10px;">Sin datos.</div>
                <div id="selected-file" style="font-size:12px; color:#64748b; margin-bottom:8px;">Archivo seleccionado: -</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="uiRunOCRSelected()" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ” OCR</button>
                    <label style="padding:8px 12px; background:#0369a1; color:#fff; border:none; border-radius:6px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;">
                        ğŸ“¤ OCR Upload (Finder)
                        <input id="ocr-upload-input" type="file" accept=".pdf,.png,.jpg,.jpeg,.tiff" style="display:none;" onchange="uiOcrUploadInput(this.files)">
                    </label>
                    <button onclick="uiPdfPreviewData()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ—‚ï¸ Preview Data</button>
                </div>
                <iframe id="pdf-frame" style="width:100%; height:300px; border:1px solid #cbd5e1; border-radius:8px;"></iframe>
                <pre id="ocr-output" style="margin-top:10px; background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:220px; overflow:auto;">OCR output...</pre>
            </div>
        </section>

        <section id="email-alerts" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ“§ Email Alerts</h2>
                <div style="display:flex; gap:8px; margin-bottom:10px; align-items:center; flex-wrap:wrap;">
                    <span id="alerts-status" style="font-size:12px; background:#f97316; color:#fff; padding:4px 10px; border-radius:12px;">SMTP?</span>
                    <input id="alerts-email" type="email" placeholder="correo@dominio.com" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:280px;">
                    <button onclick="uiSaveAlertEmail()" style="padding:8px 12px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ’¾ Guardar</button>
                    <button onclick="uiLoadAlertHistory()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ•˜ Historial</button>
                    <button onclick="uiTestAlertEmail()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ§ª Test</button>
                </div>
                <pre id="alerts-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Alerts output...</pre>
            </div>
        </section>

        <section id="firma-digital" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">âœï¸ Firma Digital</h2>
                <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; align-items:center;">
                    <input id="firma-doc-id" placeholder="doc_id o ruta PDF" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;">
                    <select id="firma-cert" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:200px;">
                        <option value=\"\">Selecciona certificado</option>
                    </select>
                    <input id="firma-pass" type="password" placeholder="passphrase (si aplica)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:180px;">
                    <button onclick="uiFirmaStatus()" style="padding:8px 12px; background:#0369a1; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“Š Estado</button>
                    <button onclick="uiFirmaSign()" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">âœï¸ Ejecutar</button>
                    <button onclick="uiSignatureCertificates()" style="padding:8px 12px; background:#475569; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ” Certificados</button>
                </div>
                <pre id="firma-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Firma output...</pre>
            </div>
        </section>

        <section id="banking" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ¦ Banking</h2>
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <button onclick="uiLoadBanking()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Cargar Banking</button>
                </div>
                <pre id="banking-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Banking output...</pre>
            </div>
        </section>

        <section id="usuarios" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ‘¥ Usuarios</h2>
                <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
                    <input id="usuarios-nombre" placeholder="Nombre (opcional)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="usuarios-email" type="email" placeholder="Email usuario" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;">
                    <select id="usuarios-rol" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="LECTURA">LECTURA</option>
                        <option value="ABOGADO">ABOGADO</option>
                        <option value="ADMIN">ADMIN</option>
                    </select>
                    <input id="usuarios-password" type="text" placeholder="Password (opcional)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <button onclick="uiLoadUsuarios()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ‘¥ Equipo</button>
                    <button onclick="uiInvitarUsuario()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“© Invitar</button>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
                    <input id="usuarios-search" placeholder="Buscar por nombre/email" oninput="applyUsuariosFilters()" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;">
                    <select id="usuarios-filter-rol" onchange="applyUsuariosFilters()" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="">Rol: todos</option>
                        <option value="ADMIN">ADMIN</option>
                        <option value="ABOGADO">ABOGADO</option>
                        <option value="LECTURA">LECTURA</option>
                    </select>
                    <select id="usuarios-filter-status" onchange="applyUsuariosFilters()" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="">Estado: todos</option>
                        <option value="Online">Online</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
                <div id="usuarios-table-wrap" style="margin-bottom:10px;"></div>
                <pre id="usuarios-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Usuarios output...</pre>
            </div>
        </section>

        <section id="pwa" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ“± PWA Status + Business Skills</h2>
                <p style="margin-top:0; color:#64748b;">
                    Monitoriza estado operativo PWA/servicios y genera estrategia procesal asistida por jurisdicciÃ³n, tipo documental y plazo.
                </p>
                <div id="pwa-status-badges" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <button onclick="uiLoadPwaBusinessStatus()" style="padding:8px 12px; background:#0f172a; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Estado</button>
                    <button onclick="uiLoadJurisdictions()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸŒ Jurisdicciones</button>
                    <select id="bs-jurisdiction" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:200px;">
                        <option value="ES_GENERAL">ES_GENERAL</option>
                    </select>
                    <button onclick="uiLoadBusinessTemplates()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“„ Templates</button>
                    <select id="bs-doc-type" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:180px;">
                        <option value="escrito_tramite">escrito_tramite</option>
                        <option value="demanda">demanda</option>
                        <option value="recurso">recurso</option>
                        <option value="lexnet_urgente">lexnet_urgente</option>
                    </select>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="bs-fecha-notificacion" type="date" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="bs-plazo-dias" type="number" value="5" min="0" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; width:130px;">
                </div>
                <textarea id="bs-query" rows="3" style="width:100%; border:1px solid #cbd5e1; border-radius:8px; padding:8px;" placeholder="Objetivo o consulta para estrategia procesal"></textarea>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button onclick="uiBuildBusinessStrategy()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ§  Construir Estrategia</button>
                    <input id="bs-client-name" placeholder="Cliente (expediente)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:200px;">
                    <input id="bs-year" type="number" min="2020" max="2100" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; width:100px;" value="2026">
                    <button onclick="uiExportBusinessStrategy('pdf')" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“„ Exportar PDF</button>
                    <button onclick="uiExportBusinessStrategy('txt')" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“ Exportar TXT</button>
                    <button onclick="uiLoadBusinessHistory()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ•˜ Historial</button>
                </div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <input id="bs-history-from" type="date" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="bs-history-to" type="date" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="bs-history-user" placeholder="Filtrar usuario (id/email)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;">
                    <button onclick="uiLoadBusinessHistory()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">Aplicar filtros</button>
                </div>
                <div id="business-structured" style="margin-top:10px;"></div>
                <div id="business-history-wrap" style="margin-top:10px;"></div>
                <pre id="business-output" style="margin-top:10px; background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Business skills output...</pre>
            </div>
        </section>

        <section id="ia-agent" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ§  Documentos E2E</h2>
                <p style="color:#64748b;">Flujo: smart-analyze â†’ propose-save â†’ confirm-save â†’ listado BD.</p>
                <div id="ia-agent-status" style="margin-bottom:10px; padding:8px 10px; border-radius:8px; background:#e2e8f0; color:#0f172a; font-size:13px;">
                    Estado: pendiente de validaciÃ³n
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="doc-e2e-file" type="file" accept=".pdf,.xml,.doc,.docx,.txt,.jpg,.jpeg,.png">
                    <input id="doc-e2e-year" type="number" value="2026" style="width:90px; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <button onclick="uiDocSmartAnalyze()" style="padding:8px 12px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer;">1) Smart Analyze</button>
                    <button onclick="uiDocProposeSave()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">2) Propose Save</button>
                    <button onclick="uiDocConfirmSave()" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">3) Confirm Save</button>
                    <button onclick="uiDocSaveOrganizedLegacy()" style="padding:8px 12px; background:#7c2d12; color:#fff; border:none; border-radius:6px; cursor:pointer;">3b) Legacy Save</button>
                    <button onclick="uiDocLoadSaved()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“š Saved</button>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="doc-path-year" type="number" value="2026" style="width:90px; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="doc-path-client" placeholder="Filtro cliente (opcional)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <button onclick="uiDocPathOptions()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“‚ Path Options</button>
                    <button onclick="uiDocTypes()" style="padding:8px 12px; background:#6b7280; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ·ï¸ Types</button>
                    <button onclick="uiDocTemplatesGenerate()" style="padding:8px 12px; background:#0891b2; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“ Templates+Generate</button>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="ia-legacy-prompt" placeholder="Prompt IA general" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:280px;">
                    <select id="ia-legacy-provider" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="ollama">ollama</option>
                        <option value="groq">groq</option>
                        <option value="openai">openai</option>
                        <option value="gemini">gemini</option>
                        <option value="deepseek">deepseek</option>
                        <option value="perplexity">perplexity</option>
                    </select>
                    <input id="ia-legacy-task" placeholder="Tarea IA Agent (opcional)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:260px;">
                    <button onclick="uiLoadAIProvidersLegacy()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ¤– AI Providers</button>
                    <button onclick="uiChatLegacy()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ’¬ Chat</button>
                    <button onclick="uiIAConsultarLegacy()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ§  IA Consultar</button>
                    <button onclick="uiIAAgentTaskLegacy()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ§© IA Agent Task</button>
                    <button onclick="uiAgentSmoke()" style="padding:8px 12px; background:#0f172a; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ§ª Smoke IA Agent</button>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="doc-saved-id" type="number" placeholder="saved doc_id" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; width:130px;">
                    <button onclick="uiDocSavedDetail()" style="padding:8px 12px; background:#1e3a8a; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ” Saved Detail</button>
                    <button onclick="uiDocPreview()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ–¼ï¸ Preview</button>
                    <button onclick="uiDocThumbnails()" style="padding:8px 12px; background:#b45309; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ§© Thumbnails</button>
                    <button onclick="uiSignatureSign()" style="padding:8px 12px; background:#7c2d12; color:#fff; border:none; border-radius:6px; cursor:pointer;">âœï¸ Signature Sign</button>
                    <button onclick="uiAIStatus()" style="padding:8px 12px; background:#0f172a; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ¤– AI Status</button>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="feedback-expediente-id" type="number" placeholder="expediente_id" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; width:140px;">
                    <input id="feedback-contenido" placeholder="feedback contenido" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:280px;">
                    <button onclick="uiAgentFeedback()" style="padding:8px 12px; background:#9333ea; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“ Agent Feedback</button>
                </div>
                <pre id="doc-e2e-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:320px; overflow:auto;">Documentos E2E output...</pre>
            </div>
        </section>

        <section id="analytics" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ“ˆ Analytics</h2>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <button onclick="uiLoadAnalytics()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Cargar Analytics</button>
                    <button onclick="uiExportAnalyticsJson()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“¦ Export JSON</button>
                </div>
                <div id="analytics-kpis" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-bottom:10px;"></div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:10px; margin-bottom:10px;">
                    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px;">
                        <h4 style="margin:0 0 8px 0;">Tendencia Ãºltimos 7 dÃ­as</h4>
                        <canvas id="analytics-trend-chart" style="max-height:220px;"></canvas>
                    </div>
                    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px;">
                        <h4 style="margin:0 0 8px 0;">DistribuciÃ³n por tipo</h4>
                        <canvas id="analytics-type-chart" style="max-height:220px;"></canvas>
                    </div>
                </div>
                <pre id="analytics-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Analytics output...</pre>
            </div>
        </section>

        <section id="expedientes" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸ“ Expedientes + iCloud</h2>
                <div id="exp-status" style="margin-bottom:10px; padding:8px 10px; border-radius:8px; background:#e2e8f0; color:#0f172a; font-size:13px;">
                    Estado: pendiente
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="exp-path" placeholder="Ruta (vacÃ­o = BASE)" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px; min-width:260px;">
                    <button onclick="uiLoadExpedientes()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“‚ Listar</button>
                    <button onclick="uiExpUp()" style="padding:8px 12px; background:#334155; color:#fff; border:none; border-radius:6px; cursor:pointer;">â¬†ï¸ Subir nivel</button>
                    <button onclick="uiIcloudStatus()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">â˜ï¸ iCloud Status</button>
                    <button onclick="uiIcloudClients()" style="padding:8px 12px; background:#475569; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ‘¥ Clients</button>
                </div>
                <div id="exp-roots" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <div id="exp-current-path" style="margin-bottom:10px; color:#334155; font-size:13px;"></div>
                <div id="exp-table-wrap" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <input id="icloud-client-name" placeholder="Cliente iCloud" style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <button onclick="uiIcloudExportDocument()" style="padding:8px 12px; background:#0ea5e9; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“„ Export Document</button>
                    <button onclick="uiIcloudExportAnalysis()" style="padding:8px 12px; background:#7c3aed; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“¤ Export Analysis</button>
                </div>
                <pre id="expedientes-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:320px; overflow:auto;">Expedientes/iCloud output...</pre>
            </div>
        </section>

        <section id="lexnet" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">âš–ï¸ LexNET</h2>
                <p style="color:#64748b;">Carga notificaciones, analiza contenido y gestiona lectura/filtros.</p>

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin:14px 0;">
                    <input id="lexnet-upload-file" type="file" accept=".xml,.pdf" />
                    <button onclick="uploadLexnetNotification()" style="padding:8px 14px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">â¬†ï¸ Subir NotificaciÃ³n</button>
                    <button onclick="loadLexnetUrgentCount()" style="padding:8px 14px; background:#7c3aed; color:white; border:none; border-radius:6px; cursor:pointer;">ğŸš¨ Urgentes</button>
                    <button onclick="uiLegacyLexnetUrgent()" style="padding:8px 14px; background:#9f1239; color:white; border:none; border-radius:6px; cursor:pointer;">ğŸš¨ Urgentes legacy</button>
                    <button onclick="uiLegacyLexnetAnalizarPlazo()" style="padding:8px 14px; background:#334155; color:white; border:none; border-radius:6px; cursor:pointer;">â±ï¸ Analizar plazo</button>
                    <span id="lexnet-urgent-badge" style="padding:8px 10px; background:#fef2f2; color:#b91c1c; border-radius:8px; border:1px solid #fecaca;">Urgentes: 0</span>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <label>Unread
                        <select id="lexnet-filter-unread" style="margin-left:6px;">
                            <option value="">Todos</option>
                            <option value="true">Solo no leÃ­das</option>
                        </select>
                    </label>
                    <label>Urgency
                        <select id="lexnet-filter-urgency" style="margin-left:6px;">
                            <option value="">Todas</option>
                            <option value="URGENT">URGENT</option>
                            <option value="HIGH">HIGH</option>
                            <option value="NORMAL">NORMAL</option>
                        </select>
                    </label>
                    <label>LÃ­mite
                        <input id="lexnet-filter-limit" type="number" min="1" max="200" value="20" style="width:80px; margin-left:6px;" />
                    </label>
                    <label>Offset
                        <input id="lexnet-filter-offset" type="number" min="0" max="5000" value="0" style="width:80px; margin-left:6px;" />
                    </label>
                    <label>Tipo
                        <input id="lexnet-filter-case-type" type="text" placeholder="JUICIO_VERBAL" style="width:150px; margin-left:6px;" />
                    </label>
                    <label>Procedimiento
                        <input id="lexnet-filter-procedure" type="text" placeholder="ABC/2026" style="width:150px; margin-left:6px;" />
                    </label>
                    <label>Desde
                        <input id="lexnet-filter-date-from" type="date" style="margin-left:6px;" />
                    </label>
                    <label>Hasta
                        <input id="lexnet-filter-date-to" type="date" style="margin-left:6px;" />
                    </label>
                    <button onclick="loadLexnetNotifications()" style="padding:8px 14px; background:#0f766e; color:white; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Cargar Notificaciones</button>
                </div>

                <div id="lexnet-notifications" style="max-height:260px; overflow:auto; border:1px solid #e2e8f0; border-radius:8px; padding:10px; background:#f8fafc; margin-bottom:14px;">
                    Sin datos.
                </div>

                <label for="lexnet-analyze-text" style="display:block; margin-bottom:6px;">Texto para anÃ¡lisis</label>
                <textarea id="lexnet-analyze-text" rows="5" style="width:100%; border:1px solid #cbd5e1; border-radius:8px; padding:8px;" placeholder="Pega aquÃ­ texto de una notificaciÃ³n para /api/lexnet/analyze"></textarea>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button onclick="analyzeLexnetText()" style="padding:8px 14px; background:#1d4ed8; color:white; border:none; border-radius:6px; cursor:pointer;">ğŸ§  Analizar</button>
                </div>
                <pre id="lexnet-analysis-output" style="margin-top:10px; background:#0f172a; color:#e2e8f0; border-radius:8px; padding:10px; max-height:240px; overflow:auto;">Resultado pendiente...</pre>
            </div>
        </section>

        <section id="config" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">âš™ï¸ ConfiguraciÃ³n</h2>
                <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-bottom:12px;">
                    <label style="display:flex; flex-direction:column; gap:6px;">
                        <span style="font-size:13px; color:#475569;">Alert email</span>
                        <input id="cfg-alert-email" type="email" placeholder="alerts@dominio.com" style="padding:8px; border:1px solid #cbd5e1; border-radius:8px;" />
                    </label>
                    <label style="display:flex; flex-direction:column; gap:6px;">
                        <span style="font-size:13px; color:#475569;">Modelo Ollama</span>
                        <input id="cfg-ollama-model" type="text" placeholder="lexdocs-legal-pro" style="padding:8px; border:1px solid #cbd5e1; border-radius:8px;" />
                    </label>
                    <label style="display:flex; flex-direction:column; gap:6px;">
                        <span style="font-size:13px; color:#475569;">Directorio pendientes</span>
                        <input id="cfg-pendientes-dir" type="text" placeholder="/Users/..../PENDIENTES_LEXDOCS" style="padding:8px; border:1px solid #cbd5e1; border-radius:8px;" />
                    </label>
                    <label style="display:flex; flex-direction:column; gap:6px;">
                        <span style="font-size:13px; color:#475569;">Provider IA por defecto</span>
                        <select id="cfg-default-provider" style="padding:8px; border:1px solid #cbd5e1; border-radius:8px;">
                            <option value="ollama">ollama</option>
                            <option value="groq">groq</option>
                            <option value="perplexity">perplexity</option>
                            <option value="openai">openai</option>
                            <option value="gemini">gemini</option>
                            <option value="deepseek">deepseek</option>
                        </select>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; margin-top:24px;">
                        <input id="cfg-ia-fallback" type="checkbox" checked />
                        <span style="font-size:13px; color:#475569;">Fallback IA activo</span>
                    </label>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <button onclick="uiLoadConfig()" style="padding:8px 12px; background:#1d4ed8; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ“¥ Cargar Config</button>
                    <button onclick="uiSaveConfig()" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">ğŸ’¾ Guardar Config</button>
                </div>
                <div id="cfg-services-badges" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <pre id="config-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Config output...</pre>
            </div>
        </section>

        <section id="deploy" class="section">
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px;">
                <h2 style="margin-top:0;">ğŸš€ Deploy Status</h2>
                <button onclick="uiLoadDeployStatus()" style="padding:8px 12px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer; margin-bottom:10px;">ğŸ”„ Cargar Deploy</button>
                <div id="deploy-badges" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <div id="deploy-runtime" style="font-size:13px; color:#475569; margin-bottom:10px;"></div>
                <pre id="deploy-output" style="background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:260px; overflow:auto;">Deploy output...</pre>
            </div>
        </section>
    </main>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- JavaScript principal -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVEGACIÃ“N ENTRE TABS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showTab(tabName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Desactivar todos los nav-items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar secciÃ³n seleccionada
            document.getElementById(tabName).classList.add('active');
            
            // Activar nav-item correspondiente
            event.target.closest('.nav-item').classList.add('active');
        }

        function openQA() {
            showTab('qa-rapida');
            closeFirstRun();
        }

        function closeFirstRun() {
            const overlay = document.getElementById('first-run-overlay');
            if (overlay) overlay.style.display = 'none';
        }

        function markFirstRunDone() {
            try {
                localStorage.setItem('lexdocs_first_run_done', '1');
            } catch (e) {}
            closeFirstRun();
        }

        function maybeShowFirstRun() {
            let done = '0';
            try {
                done = localStorage.getItem('lexdocs_first_run_done') || '0';
            } catch (e) {}
            if (done !== '1') {
                const overlay = document.getElementById('first-run-overlay');
                if (overlay) overlay.style.display = 'flex';
            }
        }

        // Estado de servicios (IA, SMTP, LexNET, Autoprocesos)
        async function loadStatusOverview() {
            try {
                const res = await fetch('/api/status/overview', { credentials: 'include' });
                const data = await res.json();
                const bar = document.getElementById('dashboard-statusbar');
                if (!bar) return;
                if (!data.success) {
                    bar.textContent = 'Estado no disponible';
                    return;
                }
                const svcs = data.services || {};
                const badge = (label, ok) => {
                    const color = ok ? '#16a34a' : '#dc2626';
                    const bg = ok ? '#dcfce7' : '#fee2e2';
                    return `<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:${bg}; color:${color}; font-weight:600;">â— ${label}</span>`;
                };
                bar.innerHTML = [
                    badge('IA local', svcs.ia_local),
                    badge('SMTP', svcs.smtp),
                    badge('LexNET', svcs.lexnet),
                    badge('Auto-Procesos', svcs.autoprocesor)
                ].join('');
            } catch (e) {
                const bar = document.getElementById('dashboard-statusbar');
                if (bar) bar.textContent = 'Estado no disponible';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CARGAR DATOS DEL DASHBOARD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let dashboardDetailedCache = null;
        let dashboardDocsOffset = 0;
        let dashboardAlertsOffset = 0;

        async function refreshDashboard() {
            const btn = document.getElementById('btn-dash-refresh');
            if (btn) { btn.disabled = true; btn.textContent = 'â³ Actualizando...'; }
            await Promise.all([
                loadDashboardStats(),
                loadDashboardDetailed(true),
                loadStatusOverview()
            ]);
            if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”„ Actualizar'; }
            const ts = new Date().toLocaleTimeString();
            const lbl = document.getElementById('dash-last-updated');
            if (lbl) lbl.textContent = `Actualizado: ${ts}`;
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats', { credentials: 'include' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('val-hoy').textContent = data.procesos_hoy || 0;
                    document.getElementById('val-rev').textContent = data.en_revision || 0;
                    document.getElementById('val-err').textContent = data.errores || 0;
                    document.getElementById('val-ale').textContent = data.alertas || 0;
                    initChartsFromCache();
                }
            } catch (error) {
                console.error('âŒ Error cargando dashboard:', error);
            }
        }

        async function loadDashboardDetailed(updateCharts) {
            const detail = document.getElementById('dashboard-detail');
            if (!detail) return;
            try {
                const rDetailed = await fetch('/api/dashboard/stats-detailed', { credentials: 'include' });
                const detailed = await rDetailed.json();
                dashboardDetailedCache = detailed;

                const dateStr = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                const rDrill = await fetch(`/api/dashboard/drill-down/by-date/${encodeURIComponent(dateStr)}?limit=10`, { credentials: 'include' });
                const drill = await rDrill.json();

                const trendCount = Array.isArray(detailed?.trends?.values) ? detailed.trends.values.reduce((a,b)=>a+b,0) : 0;
                const drillCount = Array.isArray(drill?.items) ? drill.items.length : 0;
                detail.innerHTML = `
                    <strong>Detalle operativo:</strong>
                    <div style="margin-top:8px;">Tendencia 7 dÃ­as: <b>${trendCount}</b> registros</div>
                    <div>Drill-down ${dateStr}: <b>${drillCount}</b> items</div>
                `;
                if (trendCount === 0 && drillCount === 0) {
                    detail.innerHTML += `<div style="margin-top:6px; color:#94a3b8;">Sin datos. AÃ±ade documentos o recarga.</div>`;
                }
                if (updateCharts) initChartsFromDetailed(detailed);
            } catch (e) {
                detail.textContent = `Error cargando detalle: ${e.message}`;
            }
        }

        function uiDashboardExportPDF() {
            window.open('/api/dashboard/export-pdf', '_blank');
        }

        function goToDashboardCard(kind) {
            switch (kind) {
                case 'hoy':
                    showTab('expedientes');
                    break;
                case 'revision':
                    showTab('autoprocesos');
                    break;
                case 'errores':
                    showTab('autoprocesos');
                    const logEl = document.getElementById('processing-log');
                    if (logEl) logEl.scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'alertas':
                    showTab('lexnet');
                    break;
                default:
                    showTab('dashboard');
            }
        }

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-hidden');
        }

        function goBack() {
            if (history.length > 1) {
                history.back();
            } else {
                showTab('dashboard');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GRÃFICOS CON CHART.JS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initChartsFromCache() {
            if (dashboardDetailedCache) {
                initChartsFromDetailed(dashboardDetailedCache);
            }
        }

        function initChartsFromDetailed(detailed) {
            const trends = detailed?.trends || {};
            const types = detailed?.stats?.by_type || {};
            const trendLabels = Array.isArray(trends.labels) ? trends.labels : ['Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b','Dom'];
            const trendValues = Array.isArray(trends.values) ? trends.values : [0,0,0,0,0,0,0];
            const typeLabels = Object.keys(types);
            const typeValues = Object.values(types);
            renderCharts(trendLabels, trendValues, typeLabels, typeValues);
        }

        let chartDocsInstance = null;
        let chartTypesInstance = null;
        let analyticsTrendChartInstance = null;
        let analyticsTypeChartInstance = null;
        let analyticsCache = null;

        function renderCharts(labelsDocs, valuesDocs, labelsTypes, valuesTypes) {
            // GrÃ¡fico de lÃ­nea - Documentos por dÃ­a
            const ctxDocs = document.getElementById('chart-docs').getContext('2d');
            if (chartDocsInstance) chartDocsInstance.destroy();
            chartDocsInstance = new Chart(ctxDocs, {
                type: 'line',
                data: {
                    labels: labelsDocs && labelsDocs.length ? labelsDocs : ['Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b','Dom'],
                    datasets: [{
                        label: 'Documentos Procesados',
                        data: valuesDocs && valuesDocs.length ? valuesDocs : [0,0,0,0,0,0,0],
                        borderColor: '#007BFF',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // GrÃ¡fico de dona - Tipos de documento
            const ctxTipos = document.getElementById('chart-tipos').getContext('2d');
            if (chartTypesInstance) chartTypesInstance.destroy();
            chartTypesInstance = new Chart(ctxTipos, {
                type: 'doughnut',
                data: {
                    labels: labelsTypes && labelsTypes.length ? labelsTypes : ['Contratos','Demandas','Escrituras','Otros'],
                    datasets: [{
                        data: valuesTypes && valuesTypes.length ? valuesTypes : [1,1,1,1],
                        backgroundColor: ['#007BFF','#28a745','#ffc107','#dc3545','#0ea5e9','#f97316','#a855f7']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODAL DETALLE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function openDashboardModal() {
            dashboardDocsOffset = 0;
            dashboardAlertsOffset = 0;
            await reloadModalData();
            const modal = document.getElementById('dashboard-modal');
            if (modal) modal.style.display = 'flex';
        }

        function closeDashboardModal() {
            const modal = document.getElementById('dashboard-modal');
            if (modal) modal.style.display = 'none';
        }

        async function reloadModalData() {
            await Promise.all([loadDocsPage(), loadAlertsPage()]);
        }

        async function loadDocsPage() {
            try {
                const res = await fetch(`/api/document/saved?limit=10&offset=${dashboardDocsOffset}`, { credentials: 'include' });
                const data = await res.json();
                const tbody = document.querySelector('#table-docs tbody');
                if (!tbody) return;
                if (!data.success) { tbody.innerHTML = '<tr><td colspan="2">Error cargando documentos</td></tr>'; return; }
                tbody.innerHTML = data.documents.map(d => `
                    <tr style="border-bottom:1px solid #f1f5f9;">
                        <td style="padding:6px;">${d.filename || 'â€”'}</td>
                        <td style="padding:6px;">${d.created_at || ''}</td>
                    </tr>
                `).join('');
            } catch (e) {
                const tbody = document.querySelector('#table-docs tbody');
                if (tbody) tbody.innerHTML = `<tr><td colspan="2">Error: ${e.message}</td></tr>`;
            }
        }

        async function loadAlertsPage() {
            try {
                const res = await fetch(`/api/lexnet/notifications?limit=10&offset=${dashboardAlertsOffset}`, { credentials: 'include' });
                const data = await res.json();
                const tbody = document.querySelector('#table-alerts tbody');
                if (!tbody) return;
                if (!data.success) { tbody.innerHTML = '<tr><td colspan="3">Error cargando alertas</td></tr>'; return; }
                tbody.innerHTML = data.notifications.map(n => `
                    <tr style="border-bottom:1px solid #f1f5f9;">
                        <td style="padding:6px;">${n.title || 'â€”'}</td>
                        <td style="padding:6px;">${n.created_at || ''}</td>
                        <td style="padding:6px;">${n.urgency || ''}</td>
                    </tr>
                `).join('');
            } catch (e) {
                const tbody = document.querySelector('#table-alerts tbody');
                if (tbody) tbody.innerHTML = `<tr><td colspan="3">Error: ${e.message}</td></tr>`;
            }
        }

        function changeDocsPage(delta) {
            dashboardDocsOffset = Math.max(0, dashboardDocsOffset + delta * 10);
            loadDocsPage();
        }

        function changeAlertsPage(delta) {
            dashboardAlertsOffset = Math.max(0, dashboardAlertsOffset + delta * 10);
            loadAlertsPage();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ LexDocsPro Enterprise v3.2 iniciado');
            document.body.classList.remove('sidebar-hidden');
            refreshDashboard();
            // Recargar stats cada 30 segundos
            setInterval(refreshDashboard, 30000);
        });
    
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTO-PROCESSOR FUNCTIONS (ÃšNICA VERSIÃ“N)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let processingLogCache = [];

        function loadAutoProcessorStatus() {
            fetch('/api/autoprocessor/status', {credentials:'include'})
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.status) {
                        var s = data.status;
                        
                        // KPIs
                        document.getElementById('auto-processed').textContent = s.stats.processed || 0;
                        document.getElementById('auto-pending').textContent = s.queue || 0;
                        document.getElementById('auto-errors').textContent = s.stats.errors || 0;
                        document.getElementById('auto-running').textContent = s.running ? 'â–¶ï¸' : 'â¸ï¸';
                        
                        // Panel
                        document.getElementById('auto-status').innerHTML = 
                            '<p><strong>Estado:</strong> ' + (s.running ? 'ğŸŸ¢ ACTIVO' : 'ğŸ”´ DETENIDO') + '</p>' +
                            '<p><strong>Carpeta:</strong> ' + s.watch_dir + '</p>' +
                            '<p><strong>Procesados:</strong> ' + (s.stats.processed||0) + '</p>' +
                            '<p><strong>En Cola:</strong> ' + (s.queue||0) + '</p>';
                        
                        // Cola
                        var queueHTML = '<p style="color:#999;text-align:center;padding:40px">âœ… No hay archivos</p>';
                        if (s.queue_items && s.queue_items.length > 0) {
                            queueHTML = s.queue_items.map(function(item) {
                                return '<div style="padding:10px;border-bottom:1px solid #eee">' + 
                                       '<strong>' + item.file.split('/').pop() + '</strong>' +
                                       '<span style="float:right;color:#999">' + item.status + '</span>' +
                                       '</div>';
                            }).join('');
                        }
                        document.getElementById('processing-queue').innerHTML = queueHTML;
                        
                        console.log('âœ… Status actualizado');
                    }
                })
                .catch(function(error) {
                    console.error('âŒ Error:', error);
                    document.getElementById('auto-status').innerHTML = 
                        '<p style="color:#dc3545">âŒ Error: ' + error.message + '</p>';
                });
        }
        
        function startAutoProcessor() {
            fetch('/api/autoprocessor/start', {method:'POST', credentials:'include'})
                .then(function(r) { return r.json(); })
                .then(function(d) { 
                    alert(d.message); 
                    loadAutoProcessorStatus(); 
                })
                .catch(function(e) { alert('Error: ' + e.message); });
        }
        
        function stopAutoProcessor() {
            fetch('/api/autoprocessor/stop', {method:'POST', credentials:'include'})
                .then(function(r) { return r.json(); })
                .then(function(d) { 
                    alert(d.message); 
                    loadAutoProcessorStatus(); 
                })
                .catch(function(e) { alert('Error: ' + e.message); });
        }
        
        function scanFiles() {
            if (!confirm('Â¿Escanear archivos en PENDIENTES?')) return;
            
            fetch('/api/autoprocessor/scan', {method:'POST', credentials:'include'})
                .then(function(r) { return r.json(); })
                .then(function(d) { 
                    alert(d.message); 
                    loadAutoProcessorStatus(); 
                })
                .catch(function(e) { alert('Error: ' + e.message); });
        }
        
        function resetAutoProcessor() {
            if (!confirm('Â¿Resetear contadores y estado del AutoProcessor?')) return;

            fetch('/api/autoprocessor/reset', {method:'POST', credentials:'include'})
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    alert(d.message || 'Reset ejecutado');
                    refreshAutoProcessor();
                })
                .catch(function(e) { alert('Error: ' + e.message); });
        }
        
        function refreshAutoProcessor() {
            loadAutoProcessorStatus();
            loadProcessingLog();
        }

        // Auto-actualizar cada 5 segundos si el tab estÃ¡ activo
        setInterval(function() {
            var section = document.getElementById('autoprocesos');
            if (section && section.classList.contains('active')) {
                refreshAutoProcessor();
            }
        }, 5000);

        function loadProcessingLog() {
            fetch('/api/autoprocessor/log?limit=200', {credentials:'include'})
                .then(r => r.json())
                .then(d => {
                    if (!d.success) throw new Error(d.error || 'Error log');
                    processingLogCache = d.log || [];
                    applyProcessingLogFilter();
                })
                .catch(e => {
                    document.getElementById('processing-log').innerHTML = `<p style="color:#dc2626; padding:20px;">Error cargando log: ${e.message}</p>`;
                });
        }

        function applyProcessingLogFilter() {
            const statusSel = document.getElementById('log-filter-status');
            const searchInput = document.getElementById('log-filter-search');
            const fromInput = document.getElementById('log-filter-from');
            const toInput = document.getElementById('log-filter-to');
            const statusVal = statusSel ? statusSel.value : 'ALL';
            const searchVal = (searchInput ? searchInput.value : '').toLowerCase();
            const fromVal = fromInput && fromInput.value ? fromInput.value : null;
            const toVal = toInput && toInput.value ? toInput.value : null;
            let rows = processingLogCache;
            if (statusVal !== 'ALL') {
                rows = rows.filter(r => (r.status || '').toUpperCase() === statusVal);
            }
            if (searchVal) {
                rows = rows.filter(r => (r.filename || '').toLowerCase().includes(searchVal));
            }
            if (fromVal) {
                rows = rows.filter(r => (r.completed_at || '').slice(0,10) >= fromVal);
            }
            if (toVal) {
                rows = rows.filter(r => (r.completed_at || '').slice(0,10) <= toVal);
            }
            renderProcessingLog(rows);
        }

        function renderProcessingLog(rows) {
            const container = document.getElementById('processing-log');
            if (!container) return;
            if (!rows || rows.length === 0) {
                container.innerHTML = `<p style="color:#999; text-align:center; padding:40px;">Sin registros</p>`;
                return;
            }
            const toRow = (r) => {
                const status = (r.status || '').toUpperCase();
                const badgeColor = status === 'SUCCESS' ? '#16a34a' : '#dc2626';
                let timeVal = '-';
                if (r.time) {
                    const t = Number(r.time);
                    timeVal = t < 1 ? Math.round(t * 1000) + ' ms' : t.toFixed(2) + ' s';
                }
                const ocrVal = r.ocr_chars ? r.ocr_chars : '-';
                const link = r.final_path ? `/api/autoprocessor/file?path=${encodeURIComponent(r.final_path)}&preview=1` : null;
                return `
                    <tr style="border-bottom:1px solid #e2e8f0;">
                        <td style="padding:10px; max-width:340px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${r.filename || ''}">${r.filename || ''}</td>
                        <td style="padding:10px;"><span style="padding:4px 10px; border-radius:10px; background:${badgeColor}22; color:${badgeColor}; font-weight:600;">${status || '-'}</span></td>
                        <td style="padding:10px; text-align:center;">${ocrVal}</td>
                        <td style="padding:10px; text-align:center;">${timeVal}</td>
                        <td style="padding:10px;">${r.completed_at || '-'}</td>
                        <td style="padding:10px; text-align:center;">${link ? `<a href=\"${link}\" target=\"_blank\" style=\"color:#1d4ed8;\">Ver</a>` : '-'}</td>
                    </tr>
                `;
            };
            container.innerHTML = `
                <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:0.95rem;">
                    <thead>
                        <tr style="text-align:left; border-bottom:1px solid #e2e8f0;">
                            <th style="padding:10px; width:40%;">Archivo</th>
                            <th style="padding:10px; width:14%;">Estado</th>
                            <th style="padding:10px; width:8%; text-align:center;">OCR</th>
                            <th style="padding:10px; width:10%; text-align:center;">Tiempo</th>
                            <th style="padding:10px; width:18%;">Fecha</th>
                            <th style="padding:10px; width:10%; text-align:center;">Rutas</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(toRow).join('')}
                    </tbody>
                </table>
            `;
        }

    
        // IA CASCADE FUNCTIONS (alineadas con el layout actual)
        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function loadIACascadeStatus() {
            Promise.all([
                fetch('/api/ia-cascade/stats-public').then(r => r.json()),
                fetch('/api/ia-cascade/providers-public').then(r => r.json())
            ])
            .then(([statsResp, providersResp]) => {
                if (!statsResp.success || !providersResp.success) return;

                const g = statsResp.stats.global || {};
                setText('cascade-total-calls', g.total_calls || 0);
                setText('cascade-success-calls', g.successful_calls || 0);
                setText('cascade-failed-calls', g.failed_calls || 0);
                setText('cascade-avg-uptime', `${(g.avg_uptime || 0).toFixed(2)}%`);
                setText('cascade-enabled-providers', g.enabled_providers || 0);

                const statsByProvider = statsResp.stats.providers || {};
                const providers = providersResp.providers || {};
                const tbody = document.getElementById('providers-tbody');
                if (!tbody) return;

                const sortedProviders = Object.entries(providers)
                    .sort((a, b) => (a[1].priority || 99) - (b[1].priority || 99))
                    .map(([pid, cfg]) => ({ pid, cfg, stats: statsByProvider[pid] || {} }));

                        const rows = sortedProviders.map(({pid, cfg, stats}) => {
                            const uptime = Number(stats.uptime_percentage || 0);
                            const apiStatus = cfg.local ? 'â€” (Local)' : (cfg.has_api_key ? 'âœ… Configurada' : 'âš ï¸ No configurada');
                            return `
                                <tr>
                            <td>${cfg.priority ?? '-'}</td>
                            <td>${cfg.name || pid}</td>
                            <td><code>${cfg.model || '-'}</code></td>
                            <td>${cfg.enabled ? 'âœ… Enabled' : 'âŒ Disabled'}</td>
                            <td>${stats.total_calls || 0}</td>
                            <td>${stats.successful_calls || 0}</td>
                            <td>${stats.failed_calls || 0}</td>
                            <td>${stats.avg_time ? `${Number(stats.avg_time).toFixed(2)}s` : 'N/A'}</td>
                            <td>${uptime.toFixed(1)}%</td>
                            <td>${apiStatus}</td>
                            <td>
                                <button class="btn-icon" onclick="toggleProvider('${pid}', ${!cfg.enabled})">${cfg.enabled ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                                ${cfg.local ? '' : `<button class="btn-icon" onclick="openAPIKeyModal('${pid}')">ğŸ”‘</button>`}
                                <button class="btn-icon" onclick="testProvider('${pid}')">ğŸ§ª</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows || '<tr><td colspan="11" style="padding:24px;text-align:center;color:#666;">Sin providers</td></tr>';

                // Poblar selector de test dinÃ¡micamente
                const select = document.getElementById('test-provider');
                if (select) {
                    const options = sortedProviders.map(({pid, cfg}) => {
                        const label = `${cfg.name || pid} (${cfg.model || ''})`;
                        return `<option value="${pid}">${label}</option>`;
                    }).join('');
                    select.innerHTML = `<option value="cascade">ğŸ”„ Cascade AutomÃ¡tico (Fallback)</option>${options}`;
                }
            })
            .catch(e => console.error('Error IA Cascade:', e));

            // Endpoints legacy/protegidos para observabilidad enterprise
            Promise.allSettled([
                fetch('/api/ia-cascade/health').then(r => r.json()),
                fetch('/api/ia-cascade/status').then(r => r.json()),
                fetch('/api/ia-cascade/providers').then(r => r.json()),
                fetch('/api/ia-cascade/stats').then(r => r.json())
            ]).then((results) => {
                const health = results[0].status === 'fulfilled' ? results[0].value : null;
                const healthBox = document.getElementById('cascade-health');
                if (healthBox) {
                    const ok = !!(health && (health.success || health.status === 'ok'));
                    healthBox.style.background = ok ? '#ecfeff' : '#fff7ed';
                    healthBox.style.color = ok ? '#0f766e' : '#9a3412';
                    healthBox.textContent = ok
                        ? 'Estado IA Cascade: operativo (health/status/providers/stats consultados)'
                        : 'Estado IA Cascade: revisiÃ³n requerida (algÃºn endpoint devolviÃ³ error)';
                }
            }).catch(() => {});
        }

        function testIACascade() {
            const provider = document.getElementById('test-provider')?.value || 'cascade';
            const temperature = Number(document.getElementById('test-temperature')?.value || '0.3');
            const prompt = (document.getElementById('test-prompt-input')?.value || '').trim();
            const btn = document.getElementById('btn-test-cascade');
            const resultBox = document.getElementById('test-result');
            const errorBox = document.getElementById('test-error');

            if (!prompt) {
                alert('Escribe un prompt primero');
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'â³ Ejecutando...';
            }
            if (resultBox) resultBox.style.display = 'none';
            if (errorBox) errorBox.style.display = 'none';

            fetch('/api/ia-cascade/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ provider, temperature, prompt })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    setText('result-provider', data.provider_used || provider);
                    setText('result-time', data.time ? `${Number(data.time).toFixed(2)}s` : 'N/A');
                    setText('result-tokens', data.metadata?.tokens || 'N/A');
                    setText('result-text', data.response || '');
                    if (resultBox) resultBox.style.display = 'block';
                    loadIACascadeStatus();
                    // Compatibilidad endpoint legacy query
                    return fetch('/api/ia-cascade/query', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt, provider })
                    }).then(() => null);
                } else {
                    setText('error-text', data.error || 'Error desconocido');
                    if (errorBox) errorBox.style.display = 'block';
                }
            })
            .catch(e => {
                setText('error-text', e.message);
                if (errorBox) errorBox.style.display = 'block';
            })
            .finally(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ Ejecutar Test';
                }
            });
        }

        function testProvider(providerId) {
            const select = document.getElementById('test-provider');
            if (select) select.value = providerId;
            testIACascade();
        }

        function toggleProvider(providerId, enabled) {
            fetch('/api/ia-cascade/toggle-provider', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ provider_id: providerId, enabled })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert(data.error || 'No se pudo cambiar el estado del provider');
                    return;
                }
                loadIACascadeStatus();
            })
            .catch(e => alert(`Error: ${e.message}`));
        }

        let providerModalId = null;

        function openAPIKeyModal(providerId) {
            providerModalId = providerId;
            setText('modal-provider-name', providerId.toUpperCase());
            const input = document.getElementById('modal-api-key-input');
            if (input) input.value = '';
            document.getElementById('api-key-modal')?.classList.add('visible');
        }

        function closeAPIKeyModal() {
            providerModalId = null;
            document.getElementById('api-key-modal')?.classList.remove('visible');
        }

        function saveAPIKey() {
            const input = document.getElementById('modal-api-key-input');
            const apiKey = (input?.value || '').trim();
            if (!providerModalId || !apiKey) {
                alert('Completa provider y API key');
                return;
            }

            fetch('/api/ia-cascade/update-key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ provider_id: providerModalId, api_key: apiKey })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert(data.error || 'No se pudo guardar la API key');
                    return;
                }
                closeAPIKeyModal();
                loadIACascadeStatus();
            })
            .catch(e => alert(`Error: ${e.message}`));
        }

        function refreshCascadeStats() {
            loadIACascadeStatus();
        }

        function resetCascadeStats() {
            fetch('/api/ia-cascade/reset-stats', {method: 'POST'})
                .then(r => r.json())
                .then(() => loadIACascadeStatus())
                .catch(e => alert(`Error: ${e.message}`));
        }

        function exportCascadeStats() {
            fetch('/api/ia-cascade/stats-public')
                .then(r => r.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ia-cascade-stats-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(e => alert(`Error: ${e.message}`));
        }
        
        // Cargar al abrir tab
        const origShowTab2 = window.showTab;
        window.showTab = function(tab) {
            origShowTab2(tab);
            if (tab === 'ia-cascade') {
                loadIACascadeStatus();
            }
            if (tab === 'autoprocesos') {
                loadAutoProcessorStatus();
                loadProcessingLog();
            }
            if (tab === 'lexnet') {
                loadLexnetUrgentCount();
                loadLexnetNotifications();
            }
        };

        function loadLexnetUrgentCount() {
            fetch('/api/lexnet/urgent-count')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('lexnet-urgent-badge');
                    if (!badge) return;
                    const count = data?.urgent_count || 0;
                    badge.textContent = `Urgentes: ${count}`;
                })
                .catch(e => console.error('Error urgent-count:', e));
        }

        function loadLexnetNotifications() {
            const unread = document.getElementById('lexnet-filter-unread')?.value || '';
            const urgency = document.getElementById('lexnet-filter-urgency')?.value || '';
            const limit = document.getElementById('lexnet-filter-limit')?.value || '20';
            const offset = document.getElementById('lexnet-filter-offset')?.value || '0';
            const caseType = (document.getElementById('lexnet-filter-case-type')?.value || '').trim();
            const procedure = (document.getElementById('lexnet-filter-procedure')?.value || '').trim();
            const dateFrom = document.getElementById('lexnet-filter-date-from')?.value || '';
            const dateTo = document.getElementById('lexnet-filter-date-to')?.value || '';

            const params = new URLSearchParams();
            if (unread) params.set('unread', unread);
            if (urgency) params.set('urgency', urgency);
            params.set('limit', limit);
            params.set('offset', offset);
            if (caseType) params.set('case_type', caseType);
            if (procedure) params.set('procedure_number', procedure);
            if (dateFrom) params.set('date_from', dateFrom);
            if (dateTo) params.set('date_to', dateTo);

            fetch(`/api/lexnet/notifications?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    const box = document.getElementById('lexnet-notifications');
                    if (!box) return;
                    if (!data.success) {
                        box.textContent = data.error || 'No se pudieron cargar notificaciones.';
                        return;
                    }
                    const notifications = data.notifications || [];
                    if (!notifications.length) {
                        box.textContent = 'Sin notificaciones para el filtro actual.';
                        return;
                    }
                    box.innerHTML = notifications.map(n => `
                        <div style="padding:10px; border-bottom:1px solid #e2e8f0;">
                            <div style="display:flex; justify-content:space-between; gap:8px;">
                                <strong>${n.title || 'Sin tÃ­tulo'}</strong>
                                <span>${n.urgency || 'NORMAL'}</span>
                            </div>
                            <div style="font-size:12px; color:#64748b;">ID: ${n.id} | Read: ${n.read ? 'SÃ­' : 'No'} | Procedure: ${n.procedure_number || '-'} | Case: ${n.case_type || '-'} | Fecha: ${n.created_at || '-'}</div>
                            <div style="margin-top:6px;">
                                ${n.read ? '' : `<button onclick="markLexnetRead(${n.id})" style="padding:4px 8px; border:none; border-radius:4px; background:#334155; color:white; cursor:pointer;">Marcar leÃ­da</button>`}
                            </div>
                        </div>
                    `).join('');
                })
                .catch(e => {
                    const box = document.getElementById('lexnet-notifications');
                    if (box) box.textContent = `Error: ${e.message}`;
                });
        }

        function markLexnetRead(notificationId) {
            fetch(`/api/lexnet/notifications/${notificationId}/read`, { method: 'PATCH' })
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.error || 'No se pudo marcar como leÃ­da');
                        return;
                    }
                    loadLexnetNotifications();
                    loadLexnetUrgentCount();
                })
                .catch(e => alert(`Error: ${e.message}`));
        }

        function uploadLexnetNotification() {
            const fileInput = document.getElementById('lexnet-upload-file');
            const file = fileInput?.files?.[0];
            if (!file) {
                alert('Selecciona un archivo XML/PDF');
                return;
            }
            const fd = new FormData();
            fd.append('file', file);
            fetch('/api/lexnet/upload-notification', {
                method: 'POST',
                body: fd
            })
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.error || 'No se pudo subir la notificaciÃ³n');
                        return;
                    }
                    loadLexnetNotifications();
                    loadLexnetUrgentCount();
                })
                .catch(e => alert(`Error: ${e.message}`));
        }

        function analyzeLexnetText() {
            const text = (document.getElementById('lexnet-analyze-text')?.value || '').trim();
            const out = document.getElementById('lexnet-analysis-output');
            if (!text) {
                alert('Pega texto a analizar');
                return;
            }
            if (out) out.textContent = 'Analizando...';
            fetch('/api/lexnet/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    textos: { principal: text },
                    provider: 'ollama',
                    archivos: ['frontend_manual.txt'],
                    nombre: 'Analisis UI LexNET'
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (out) {
                        out.textContent = data.success ? (data.analisis || '') : (data.error || 'Error desconocido');
                    }
                })
                .catch(e => {
                    if (out) out.textContent = `Error: ${e.message}`;
                });
        }

        const uiState = {
            selectedFilePath: null,
            doc: {
                smartAnalyze: null,
                proposal: null,
                saved: null
            }
        };

        function pretty(v) {
            try { return JSON.stringify(v, null, 2); } catch { return String(v); }
        }

        async function apiJson(url, options = {}) {
            const resp = await fetch(url, {
                credentials: 'include',
                ...options
            });
            const data = await resp.json().catch(() => ({}));
            return { ok: resp.ok, status: resp.status, data };
        }

        function setPre(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = typeof value === 'string' ? value : pretty(value);
        }

        function setIaAgentStatus(message, ok = true) {
            const el = document.getElementById('ia-agent-status');
            if (!el) return;
            el.textContent = `Estado: ${message}`;
            el.style.background = ok ? '#dcfce7' : '#fee2e2';
            el.style.color = ok ? '#166534' : '#991b1b';
        }

        async function uiLoadFiles() {
            const p = document.getElementById('files-path')?.value || '';
            const { data } = await apiJson(`/api/files?path=${encodeURIComponent(p)}`);
            const box = document.getElementById('files-list');
            const rootsBox = document.getElementById('files-roots');
            if (!box) return;
            const folders = data.folders || [];
            const files = data.files || [];
            const roots = data.roots || [];
            if (rootsBox) {
                rootsBox.innerHTML = roots.map(r => `
                    <button style="padding:6px 10px; border:1px solid #cbd5e1; background:#f8fafc; border-radius:6px; cursor:pointer;"
                        onclick="document.getElementById('files-path').value='${r}'; uiLoadFiles()">${r}</button>
                `).join('') || '';
            }
            box.innerHTML = [
                ...folders.map(f => `<div style=\"padding:6px; cursor:pointer;\" onclick=\"document.getElementById('files-path').value='${f.path}'; uiLoadFiles()\">ğŸ“ ${f.name}</div>`),
                ...files.map(f => `<div style=\"padding:6px; cursor:pointer;\" onclick=\"uiSelectFile('${f.path}')\">ğŸ“„ ${f.name}</div>`)
            ].join('') || 'Sin datos.';
            // autoseleccionar primero
            if (!uiState.selectedFilePath && files.length) {
                uiSelectFile(files[0].path);
            }
        }

        function uiSelectFile(path) {
            uiState.selectedFilePath = path;
            const selected = document.getElementById('selected-file');
            if (selected) selected.textContent = `Archivo seleccionado: ${path}`;
            const frame = document.getElementById('pdf-frame');
            if (frame) frame.src = `/api/pdf/${encodeURIComponent(path)}`;
        }

        async function uiRunOCRSelected() {
            if (!uiState.selectedFilePath) {
                setPre('ocr-output', 'Selecciona un archivo PDF primero.');
                return;
            }
            const { data } = await apiJson('/api/ocr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: uiState.selectedFilePath })
            });
            setPre('ocr-output', data.success ? (data.text || '') : data);
        }

        async function uiAutoLegacyDocumento() {
            const id = document.getElementById('auto-doc-id')?.value;
            if (!id) return alert('Indica doc_id');
            const { data } = await apiJson(`/api/autoprocesador/documento/${id}`);
            setPre('doc-e2e-output', data);
        }

        async function uiAutoLegacyAprobar() {
            const id = document.getElementById('auto-doc-id')?.value;
            if (!id) return alert('Indica doc_id');
            const { data } = await apiJson(`/api/autoprocesador/aprobar/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            setPre('doc-e2e-output', data);
        }

        async function uiAutoLegacyRechazar() {
            const id = document.getElementById('auto-doc-id')?.value;
            if (!id) return alert('Indica doc_id');
            const { data } = await apiJson(`/api/autoprocesador/rechazar/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ motivo: 'Rechazo desde UI activa' })
            });
            setPre('doc-e2e-output', data);
        }

        function uiAutoLegacyPdf() {
            const id = document.getElementById('auto-doc-id')?.value;
            if (!id) return alert('Indica doc_id');
            const frame = document.getElementById('pdf-frame');
            if (frame) frame.src = `/api/autoprocesador/pdf/${id}`;
        }

        async function uiAutoLegacyStats() {
            const { data } = await apiJson('/api/autoprocesador/stats');
            setPre('auto-legacy-output', data);
        }

        async function uiAutoLegacyQueue() {
            const { data } = await apiJson('/api/autoprocesador/cola-revision');
            setPre('auto-legacy-output', data);
        }

        async function uiAutoLegacyProcessedToday() {
            const { data } = await apiJson('/api/autoprocesador/procesados-hoy');
            setPre('auto-legacy-output', data);
        }

        async function uiAutoLegacyClientes() {
            const { data } = await apiJson('/api/autoprocesador/clientes');
            setPre('auto-legacy-output', data);
        }

        async function uiLegacyLogs() {
            const { data } = await apiJson('/api/autoprocesos/logs');
            setPre('auto-legacy-output', data);
        }

        async function uiLegacyToggle() {
            const { data } = await apiJson('/api/autoprocesos/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'status' })
            });
            setPre('auto-legacy-output', data);
        }

        async function uiLegacyWatchdog() {
            const { data } = await apiJson('/api/watchdog-status');
            setPre('auto-legacy-output', data);
        }

        async function uiOcrUploadQuick() {
            const file = document.getElementById('doc-e2e-file')?.files?.[0]
                || document.getElementById('lexnet-upload-file')?.files?.[0];
            if (!file) {
                setPre('ocr-output', 'Selecciona un archivo en Documentos E2E o LexNET para OCR Upload.');
                return;
            }
            const fd = new FormData();
            fd.append('file', file);
            const { data, status } = await apiJson('/api/ocr/upload', {
                method: 'POST',
                body: fd
            });
            setPre('ocr-output', { status, ...data });
        }

        async function uiPdfPreviewData() {
            const { data } = await apiJson('/api/pdf/preview-data');
            setPre('pdf-preview-output', data);
        }

        async function uiLoadAIProvidersLegacy() {
            const { data } = await apiJson('/api/ai/providers');
            const sel = document.getElementById('ia-legacy-provider');
            if (sel && Array.isArray(data?.providers) && data.providers.length) {
                sel.innerHTML = data.providers
                    .map(p => `<option value="${p}">${p}</option>`)
                    .join('');
                if (data.default) sel.value = data.default;
            }
            setIaAgentStatus(`Providers cargados (${(data?.providers || []).length})`, true);
            setPre('doc-e2e-output', data);
        }

        async function uiChatLegacy() {
            const prompt = document.getElementById('ia-legacy-prompt')?.value || 'Resumen de estado legal';
            const provider = document.getElementById('ia-legacy-provider')?.value || 'ollama';
            const { data } = await apiJson('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt,
                    context: '',
                    provider,
                    mode: 'standard'
                })
            });
            setIaAgentStatus(data?.success ? `Chat OK (${provider})` : `Chat error (${provider})`, !!data?.success);
            setPre('doc-e2e-output', data);
        }

        async function uiIAConsultarLegacy() {
            const prompt = document.getElementById('ia-legacy-prompt')?.value || 'Analiza esta consulta';
            const provider = document.getElementById('ia-legacy-provider')?.value || 'ollama';
            const { data } = await apiJson('/api/ia/consultar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, provider })
            });
            setIaAgentStatus(data?.success ? `Consulta IA OK (${provider})` : `Consulta IA error (${provider})`, !!data?.success);
            setPre('doc-e2e-output', data);
        }

        async function uiIAAgentTaskLegacy() {
            const task = document.getElementById('ia-legacy-task')?.value || 'Preparar checklist de revisiÃ³n documental';
            const { data } = await apiJson('/api/ia/agent-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task })
            });
            setIaAgentStatus(data?.success ? 'IA Agent Task OK' : 'IA Agent Task error', !!data?.success);
            setPre('doc-e2e-output', data);
        }

        async function uiLegacyLexnetUrgent() {
            const { data } = await apiJson('/api/lexnet-urgent');
            setPre('lexnet-analysis-output', data);
        }

        async function uiLegacyLexnetAnalizarPlazo() {
            const { data } = await apiJson('/api/lexnet/analizar-plazo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dias: 20 })
            });
            setPre('lexnet-analysis-output', data);
        }

        async function uiDocSmartAnalyze() {
            const file = document.getElementById('doc-e2e-file')?.files?.[0];
            const hintYear = Number(document.getElementById('doc-e2e-year')?.value || '2026');
            if (!file) {
                setPre('doc-e2e-output', 'Selecciona archivo para smart-analyze.');
                return;
            }
            const fd = new FormData();
            fd.append('file', file);
            fd.append('hint_year', String(hintYear));
            const { data } = await apiJson('/api/document/smart-analyze', { method: 'POST', body: fd });
            uiState.doc.smartAnalyze = data;
            setPre('doc-e2e-output', data);
        }

        async function uiDocProposeSave() {
            const smart = uiState.doc.smartAnalyze;
            if (!smart?.success || !smart?.temp_file_path) {
                setPre('doc-e2e-output', 'Ejecuta primero Smart Analyze.');
                return;
            }
            const metadata = smart.metadata || {};
            const payload = {
                temp_file_path: smart.temp_file_path,
                extracted_data: {
                    client: metadata.client || metadata.nombre_cliente || 'SIN_CLASIFICAR',
                    doc_type: metadata.doc_type || metadata.tipo_documento || 'documento',
                    date: metadata.date || metadata.fecha_documento || `${metadata.year || 2026}-01-01`,
                    expedient: metadata.expedient || metadata.numero_procedimiento || '',
                    court: metadata.court || '',
                    year: metadata.year || metadata.ano || 2026,
                    confidence: metadata.confidence || metadata.confianza || 70
                },
                hint_year: Number(document.getElementById('doc-e2e-year')?.value || '2026')
            };
            const { data } = await apiJson('/api/document/propose-save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            uiState.doc.proposal = data;
            setPre('doc-e2e-output', data);
        }

        async function uiDocConfirmSave() {
            const smart = uiState.doc.smartAnalyze;
            const proposal = uiState.doc.proposal;
            if (!smart?.temp_file_path || !proposal?.proposal) {
                setPre('doc-e2e-output', 'Ejecuta Smart Analyze + Propose Save primero.');
                return;
            }
            const confirmed = proposal.proposal;
            const { data } = await apiJson('/api/document/confirm-save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    temp_file_path: smart.temp_file_path,
                    pending_document_id: proposal.pending_document_id || null,
                    confirmed_data: confirmed
                })
            });
            uiState.doc.saved = data;
            if (data?.document_id) {
                const idEl = document.getElementById('doc-saved-id');
                if (idEl) idEl.value = String(data.document_id);
                const fbEl = document.getElementById('feedback-expediente-id');
                if (fbEl && !fbEl.value) fbEl.value = String(data.document_id);
            }
            setPre('doc-e2e-output', data);
        }

        async function uiDocSaveOrganizedLegacy() {
            const smart = uiState.doc.smartAnalyze;
            const proposal = uiState.doc.proposal;
            if (!smart?.temp_file_path || !proposal?.proposal?.final_path) {
                setPre('doc-e2e-output', 'Requiere Smart Analyze + Propose Save.');
                return;
            }
            const { data } = await apiJson('/api/document/save-organized', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    temp_file_path: smart.temp_file_path,
                    dest_path: proposal.proposal.final_path
                })
            });
            setPre('doc-e2e-output', data);
        }

        async function uiDocPathOptions() {
            const year = Number(document.getElementById('doc-path-year')?.value || '2026');
            const client = document.getElementById('doc-path-client')?.value || '';
            const { data } = await apiJson(`/api/document/path-options?year=${year}&client=${encodeURIComponent(client)}`);
            setPre('doc-e2e-output', data);
        }

        async function uiDocTypes() {
            const { data } = await apiJson('/api/document/types');
            setPre('doc-e2e-output', data);
        }

        async function uiDocLoadSaved() {
            const { data } = await apiJson('/api/document/saved?limit=20');
            if (data?.documents?.length) {
                const firstId = data.documents[0].id;
                const idInput = document.getElementById('doc-saved-id');
                if (idInput) idInput.value = String(firstId);
                const fbEl = document.getElementById('feedback-expediente-id');
                if (fbEl && !fbEl.value) fbEl.value = String(firstId);
                const detail = await apiJson(`/api/document/saved/${firstId}`);
                setPre('doc-e2e-output', { list: data, first_detail: detail.data });
            } else {
                setPre('doc-e2e-output', data);
            }
        }

        async function uiAgentSmoke() {
            try {
                const p = await apiJson('/api/ai/providers');
                const provider = (p.data?.default || (p.data?.providers || [])[0] || 'ollama');
                const c = await apiJson('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: 'Ping legal', context: '', provider, mode: 'standard' })
                });
                const q = await apiJson('/api/ia/consultar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: 'Checklist breve', provider })
                });
                const t = await apiJson('/api/ia/agent-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task: 'Generar 3 pasos de revisiÃ³n' })
                });
                const ok = !!(c.data?.success && q.data?.success && t.data?.success);
                setIaAgentStatus(ok ? 'Smoke IA Agent en verde' : 'Smoke IA Agent con incidencias', ok);
                setPre('doc-e2e-output', {
                    providers: p.data,
                    chat: c.data,
                    consultar: q.data,
                    agent_task: t.data,
                    smoke_ok: ok
                });
            } catch (e) {
                setIaAgentStatus(`Smoke fallÃ³: ${e.message}`, false);
                setPre('doc-e2e-output', { success: false, error: e.message });
            }
        }

        async function uiDocSavedDetail() {
            const id = document.getElementById('doc-saved-id')?.value;
            if (!id) return alert('Indica saved doc_id');
            const { data } = await apiJson(`/api/document/saved/${id}`);
            setPre('doc-e2e-output', data);
        }

        async function uiDocPreview() {
            const smart = uiState.doc.smartAnalyze;
            if (!smart?.temp_file_path) {
                setPre('doc-e2e-output', 'Requiere Smart Analyze (temp_file_path).');
                return;
            }
            const { data } = await apiJson('/api/document/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ temp_file_path: smart.temp_file_path, page: 1 })
            });
            setPre('doc-e2e-output', data);
        }

        async function uiDocThumbnails() {
            const smart = uiState.doc.smartAnalyze;
            if (!smart?.temp_file_path) {
                setPre('doc-e2e-output', 'Requiere Smart Analyze (temp_file_path).');
                return;
            }
            const { data } = await apiJson('/api/document/thumbnails', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ temp_file_path: smart.temp_file_path })
            });
            setPre('doc-e2e-output', data);
        }

        async function uiDocTemplatesGenerate() {
            const templatesRes = await apiJson('/api/documents/templates');
            const templates = templatesRes.data || {};
            const firstType = Object.keys(templates)[0];
            if (!firstType) {
                setPre('doc-e2e-output', { success: false, error: 'Sin templates' });
                return;
            }
            const tpl = templates[firstType];
            const payload = {};
            (tpl.fields || []).forEach(f => {
                payload[f.name] = f.type === 'date' ? '2026-02-05' : `Demo ${f.label || f.name}`;
            });
            const gen = await apiJson('/api/documents/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: firstType, data: payload, provider: 'ollama' })
            });
            setPre('doc-e2e-output', { templates: templatesRes.data, generate: gen.data });
        }

        async function uiIcloudStatus() {
            const { data } = await apiJson('/api/icloud/status');
            setExpStatus(data?.success ? 'iCloud operativo' : 'iCloud con incidencias', !!data?.success);
            setPre('expedientes-output', data);
        }

        async function uiIcloudClients() {
            const { data } = await apiJson('/api/icloud/clients');
            setExpStatus(`Clientes iCloud: ${(data?.clients || []).length}`, !!data?.success);
            setPre('expedientes-output', data);
        }

        async function uiIcloudExportAnalysis() {
            const client = document.getElementById('icloud-client-name')?.value || 'CLIENTE_DEMO';
            const content = document.getElementById('doc-e2e-output')?.textContent || 'AnÃ¡lisis demo';
            const { data } = await apiJson('/api/icloud/export-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, client_name: client })
            });
            setExpStatus(data?.success ? 'AnÃ¡lisis exportado a iCloud' : 'Error exportando anÃ¡lisis', !!data?.success);
            setPre('expedientes-output', data);
        }

        async function uiIcloudExportDocument() {
            const client = document.getElementById('icloud-client-name')?.value || 'CLIENTE_DEMO';
            const content = document.getElementById('doc-e2e-output')?.textContent || 'Documento demo';
            const { data } = await apiJson('/api/icloud/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content,
                    filename: `documento_${Date.now()}.txt`,
                    year: new Date().getFullYear(),
                    client_name: client,
                    subfolder: 'EXPORTS_UI'
                })
            });
            setExpStatus(data?.success ? 'Documento exportado a iCloud' : 'Error exportando documento', !!data?.success);
            setPre('expedientes-output', data);
        }

        function setExpStatus(message, ok = true) {
            const el = document.getElementById('exp-status');
            if (!el) return;
            el.textContent = `Estado: ${message}`;
            el.style.background = ok ? '#dcfce7' : '#fee2e2';
            el.style.color = ok ? '#166534' : '#991b1b';
        }

        function formatBytes(bytes) {
            if (bytes === null || bytes === undefined || Number.isNaN(Number(bytes))) return '-';
            const n = Number(bytes);
            if (n < 1024) return `${n} B`;
            if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
            if (n < 1024 * 1024 * 1024) return `${(n / (1024 * 1024)).toFixed(1)} MB`;
            return `${(n / (1024 * 1024 * 1024)).toFixed(1)} GB`;
        }

        function renderExpRoots(roots) {
            const box = document.getElementById('exp-roots');
            if (!box) return;
            box.innerHTML = (roots || []).map(r => `
                <button onclick="uiLoadExpedientes('${String(r).replace(/'/g, "\\'")}')"
                    style="padding:6px 10px; border:1px solid #cbd5e1; background:#f8fafc; border-radius:999px; cursor:pointer;">
                    ${r}
                </button>
            `).join('');
        }

        function renderExpTable(data) {
            const wrap = document.getElementById('exp-table-wrap');
            const currentPathEl = document.getElementById('exp-current-path');
            if (currentPathEl) currentPathEl.textContent = `Ruta actual: ${data?.current_path || '-'}`;
            if (!wrap) return;
            const files = Array.isArray(data?.files) ? data.files : [];
            if (!files.length) {
                wrap.innerHTML = `<div style="padding:10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff;">Sin elementos en esta ruta.</div>`;
                return;
            }
            const rows = files.map(f => `
                <tr>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${f.is_dir ? 'ğŸ“' : 'ğŸ“„'}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0; max-width:460px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${f.name || '-'}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${f.is_dir ? '-' : formatBytes(f.size)}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${f.mtime || '-'}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">
                        ${f.is_dir
                            ? `<button onclick="uiLoadExpedientes('${String(f.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px; border:none; border-radius:6px; background:#1d4ed8; color:#fff; cursor:pointer;">Abrir</button>`
                            : `<button onclick="uiSetPath('${String(f.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px; border:none; border-radius:6px; background:#334155; color:#fff; cursor:pointer;">Ruta</button>`
                        }
                    </td>
                </tr>
            `).join('');

            wrap.innerHTML = `
                <div style="border:1px solid #e2e8f0; border-radius:10px; background:#fff; overflow:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead style="background:#f8fafc;">
                            <tr>
                                <th style="text-align:left; padding:8px; width:50px;">Tipo</th>
                                <th style="text-align:left; padding:8px;">Nombre</th>
                                <th style="text-align:left; padding:8px; width:120px;">TamaÃ±o</th>
                                <th style="text-align:left; padding:8px; width:160px;">Modificado</th>
                                <th style="text-align:left; padding:8px; width:90px;">AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function uiSetPath(path) {
            const input = document.getElementById('exp-path');
            if (input) input.value = path || '';
        }

        function uiExpUp() {
            if (!window.uiExpedientesLastData?.parent_path) {
                alert('No hay nivel superior disponible.');
                return;
            }
            uiLoadExpedientes(window.uiExpedientesLastData.parent_path);
        }

        async function uiLoadExpedientes(pathOverride = null) {
            const pathInput = document.getElementById('exp-path');
            const path = pathOverride !== null ? pathOverride : (pathInput?.value || '');
            if (pathInput && pathOverride !== null) pathInput.value = pathOverride;
            const { data } = await apiJson(`/api/expedientes/listar?path=${encodeURIComponent(path)}`);
            window.uiExpedientesLastData = data;
            renderExpRoots(data?.roots || []);
            renderExpTable(data);
            setExpStatus(data?.success ? `Listado cargado (${(data?.files || []).length} elementos)` : (data?.error || 'Error listando'), !!data?.success);
            setPre('expedientes-output', data);
        }

        async function uiSaveAlertEmail() {
            const email = document.getElementById('alerts-email')?.value || '';
            const { data } = await apiJson('/api/alerts/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            setPre('alerts-output', data);
            await uiAlertsStatus();
        }

        async function uiLoadAlertHistory() {
            const { data } = await apiJson('/api/alerts/history');
            setPre('alerts-output', data?.history?.length ? data : { history: data.history || [], info: 'Sin historial real' });
        }

        async function uiTestAlertEmail() {
            const email = document.getElementById('alerts-email')?.value || '';
            const { data } = await apiJson('/api/alerts/test-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            setPre('alerts-output', data);
        }

        async function uiAlertsStatus() {
            const badge = document.getElementById('alerts-status');
            const { data } = await apiJson('/api/alerts/status');
            if (badge) {
                const ok = data.smtp_configured;
                badge.textContent = ok ? 'SMTP OK' : `SMTP incompleto: ${data.error || 'configurar'}`;
                badge.style.background = ok ? '#16a34a' : '#f97316';
                badge.style.color = '#fff';
                badge.style.padding = '4px 10px';
                badge.style.borderRadius = '12px';
            }
            setPre('alerts-output', data);
        }

        async function uiFirmaStatus() {
            const { data } = await apiJson('/api/firma/status');
            if (data?.certificates) {
                const sel = document.getElementById('firma-cert');
                if (sel) {
                    sel.innerHTML = `<option value=\"\">Selecciona certificado</option>` + data.certificates.map(c => `<option value=\"${c.name}\">${c.name}</option>`).join('');
                }
            }
            setPre('firma-output', data);
        }

        async function uiFirmaSign() {
            const docId = document.getElementById('firma-doc-id')?.value || '';
            const cert = document.getElementById('firma-cert')?.value || '';
            const pass = document.getElementById('firma-pass')?.value || '';
            if (!docId) return setPre('firma-output', 'Indica doc_id o ruta de PDF');
            if (!cert) return setPre('firma-output', 'Selecciona un certificado .p12');
            const { data } = await apiJson('/api/signature/sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ doc_id: docId, certificate: cert, passphrase: pass })
            });
            setPre('firma-output', data);
        }

        async function uiSignatureCertificates() {
            const { data } = await apiJson('/api/signature/certificates');
            if (data?.certificates) {
                const sel = document.getElementById('firma-cert');
                if (sel) {
                    sel.innerHTML = `<option value=\"\">Selecciona certificado</option>` + data.certificates.map(c => `<option value=\"${c.name}\">${c.name}</option>`).join('');
                }
            }
            setPre('firma-output', data);
        }

        async function uiSignatureSign() {
            const id = document.getElementById('doc-saved-id')?.value;
            if (!id) return alert('Indica saved doc_id para firmar');
            const certResp = await apiJson('/api/signature/certificates');
            const cert = certResp.data?.certificates?.[0];
            const certName = cert?.name || cert?.filename || '';
            const { data } = await apiJson('/api/signature/sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doc_id: Number(id),
                    certificate: certName || 'demo-cert.p12',
                    passphrase: 'demo'
                })
            });
            setPre('doc-e2e-output', data);
        }

        async function uiLoadBanking() {
            const [stats, institutions, tx] = await Promise.all([
                apiJson('/api/banking/stats'),
                apiJson('/api/banking/institutions'),
                apiJson('/api/banking/transactions')
            ]);
            setPre('banking-output', {
                stats: stats.data,
                institutions: institutions.data,
                transactions: tx.data
            });
        }

        async function uiLoadUsuarios() {
            const { data } = await apiJson('/api/usuarios/equipo');
            window.uiUsuariosCache = data?.usuarios || [];
            applyUsuariosFilters();
            setPre('usuarios-output', data);
        }

        async function uiInvitarUsuario() {
            const nombre = document.getElementById('usuarios-nombre')?.value || '';
            const email = document.getElementById('usuarios-email')?.value || '';
            const rol = document.getElementById('usuarios-rol')?.value || 'LECTURA';
            const password = document.getElementById('usuarios-password')?.value || '';
            const { data } = await apiJson('/api/usuarios/registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, email, rol, password })
            });
            setPre('usuarios-output', data);
            if (data?.success) {
                await uiLoadUsuarios();
            }
        }

        function renderUsuariosTable(items) {
            const wrap = document.getElementById('usuarios-table-wrap');
            if (!wrap) return;
            if (!items.length) {
                wrap.innerHTML = '<div style="color:#64748b;">Sin usuarios para mostrar.</div>';
                return;
            }
            wrap.innerHTML = `
                <div style="overflow:auto; border:1px solid #e2e8f0; border-radius:8px;">
                    <table style="width:100%; border-collapse:collapse; font-size:14px;">
                        <thead style="background:#f8fafc;">
                            <tr>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Nombre</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Email</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Rol</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Estado</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Actividad</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">AcciÃ³n</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Seguridad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(u => `
                                <tr>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">${u.nombre || '-'}</td>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">${u.email || '-'}</td>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">${u.rol || '-'}</td>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">${u.status || '-'}</td>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">${u.actividad || '-'}</td>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">
                                        <button onclick="uiToggleUsuario(${u.id}, ${u.status === 'Online' ? 'false' : 'true'})"
                                            style="padding:4px 8px; border:none; border-radius:6px; cursor:pointer; background:${u.status === 'Online' ? '#ef4444' : '#16a34a'}; color:#fff;">
                                            ${u.status === 'Online' ? 'Desactivar' : 'Activar'}
                                        </button>
                                    </td>
                                    <td style="padding:8px; border-bottom:1px solid #f1f5f9;">
                                        <button onclick="uiResetUsuarioPassword(${u.id})"
                                            style="padding:4px 8px; border:none; border-radius:6px; cursor:pointer; background:#f59e0b; color:#111827;">
                                            Reset pass
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function applyUsuariosFilters() {
            const items = window.uiUsuariosCache || [];
            const q = (document.getElementById('usuarios-search')?.value || '').toLowerCase().trim();
            const rol = (document.getElementById('usuarios-filter-rol')?.value || '').toUpperCase();
            const status = document.getElementById('usuarios-filter-status')?.value || '';
            const filtered = items.filter(u => {
                const text = `${u.nombre || ''} ${u.email || ''}`.toLowerCase();
                const matchQ = !q || text.includes(q);
                const matchRol = !rol || (u.rol || '').toUpperCase() === rol;
                const matchStatus = !status || (u.status || '') === status;
                return matchQ && matchRol && matchStatus;
            });
            renderUsuariosTable(filtered);
        }

        async function uiToggleUsuario(userId, activo) {
            const { data } = await apiJson(`/api/usuarios/${userId}/estado`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activo: String(activo) === 'true' })
            });
            setPre('usuarios-output', data);
            if (data?.success) await uiLoadUsuarios();
        }

        async function uiResetUsuarioPassword(userId) {
            const { data } = await apiJson(`/api/usuarios/${userId}/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            setPre('usuarios-output', data);
        }

        async function uiLoadAnalytics() {
            const { data } = await apiJson('/api/dashboard/stats-detailed');
            analyticsCache = data;
            renderAnalytics(data);
            setPre('analytics-output', data);
        }

        function renderAnalytics(data) {
            const kpiWrap = document.getElementById('analytics-kpis');
            if (!kpiWrap) return;

            if (!data?.success) {
                kpiWrap.innerHTML = `<div style="padding:10px; border:1px solid #fecaca; border-radius:8px; background:#fef2f2; color:#991b1b;">No se pudo cargar analytics.</div>`;
                return;
            }

            const kpis = data.kpis || {};
            const totalDocs = data.stats?.total_documents || 0;
            const recentDocs = (data.recent_docs || []).length;
            const recentAlerts = (data.recent_alerts || []).length;

            kpiWrap.innerHTML = `
                <div style="padding:12px; border-radius:10px; border:1px solid #bfdbfe; background:#eff6ff;"><div style="font-size:12px;color:#1d4ed8;">Hoy</div><div style="font-size:26px;font-weight:700;">${kpis.today || 0}</div></div>
                <div style="padding:12px; border-radius:10px; border:1px solid #bbf7d0; background:#f0fdf4;"><div style="font-size:12px;color:#166534;">Semana</div><div style="font-size:26px;font-weight:700;">${kpis.week || 0}</div></div>
                <div style="padding:12px; border-radius:10px; border:1px solid #ddd6fe; background:#f5f3ff;"><div style="font-size:12px;color:#6d28d9;">Total docs</div><div style="font-size:26px;font-weight:700;">${totalDocs}</div></div>
                <div style="padding:12px; border-radius:10px; border:1px solid #fde68a; background:#fffbeb;"><div style="font-size:12px;color:#92400e;">Recientes</div><div style="font-size:26px;font-weight:700;">${recentDocs}</div></div>
                <div style="padding:12px; border-radius:10px; border:1px solid #fecaca; background:#fef2f2;"><div style="font-size:12px;color:#991b1b;">Alertas</div><div style="font-size:26px;font-weight:700;">${recentAlerts}</div></div>
            `;

            const trendLabels = data.trends?.labels || [];
            const trendValues = data.trends?.values || [];
            const typeObj = data.stats?.by_type || {};
            const typeLabels = Object.keys(typeObj);
            const typeValues = typeLabels.map(k => typeObj[k]);

            const trendCanvas = document.getElementById('analytics-trend-chart');
            const typeCanvas = document.getElementById('analytics-type-chart');
            if (!trendCanvas || !typeCanvas || typeof Chart === 'undefined') return;

            if (analyticsTrendChartInstance) analyticsTrendChartInstance.destroy();
            if (analyticsTypeChartInstance) analyticsTypeChartInstance.destroy();

            analyticsTrendChartInstance = new Chart(trendCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Docs',
                        data: trendValues,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37,99,235,0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            analyticsTypeChartInstance = new Chart(typeCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Cantidad',
                        data: typeValues,
                        backgroundColor: ['#16a34a','#2563eb','#f59e0b','#7c3aed','#ef4444','#0ea5e9']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function uiExportAnalyticsJson() {
            if (!analyticsCache) {
                alert('Primero carga Analytics.');
                return;
            }
            const blob = new Blob([JSON.stringify(analyticsCache, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function uiLoadConfig() {
            const { data } = await apiJson('/api/config/get');
            const cfg = data?.config || {};
            const set = (id, val='') => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.type === 'checkbox') el.checked = !!val;
                else el.value = val ?? '';
            };
            set('cfg-alert-email', cfg.alert_email || '');
            set('cfg-ollama-model', cfg.ollama_model || '');
            set('cfg-pendientes-dir', cfg.pendientes_dir || '');
            set('cfg-default-provider', cfg.default_ai_provider || 'ollama');
            set('cfg-ia-fallback', !!cfg.ia_fallback);
            renderConfigServiceBadges(data?.services || {});
            setPre('config-output', data);
        }

        async function uiSaveConfig() {
            const { data } = await apiJson('/api/config/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    alert_email: document.getElementById('cfg-alert-email')?.value || '',
                    ollama_model: document.getElementById('cfg-ollama-model')?.value || '',
                    pendientes_dir: document.getElementById('cfg-pendientes-dir')?.value || '',
                    default_ai_provider: document.getElementById('cfg-default-provider')?.value || 'ollama',
                    ia_fallback: !!document.getElementById('cfg-ia-fallback')?.checked
                })
            });
            setPre('config-output', data);
            await uiLoadConfig();
        }

        function renderConfigServiceBadges(services) {
            const wrap = document.getElementById('cfg-services-badges');
            if (!wrap) return;
            const entries = [
                ['IA Cascade', !!services?.ia_cascade?.ok],
                ['SMTP', !!services?.smtp?.ok],
                ['LexNET', !!services?.lexnet?.ok],
                ['Watchdog', !!services?.watchdog?.ok]
            ];
            wrap.innerHTML = entries.map(([label, ok]) => {
                const bg = ok ? '#dcfce7' : '#fef3c7';
                const fg = ok ? '#166534' : '#92400e';
                const dot = ok ? 'â—' : 'â—';
                return `<span style="padding:6px 10px; border-radius:999px; background:${bg}; color:${fg}; font-weight:600;">${dot} ${label}</span>`;
            }).join('');
        }

        async function uiLoadDeployStatus() {
            const { data } = await apiJson('/api/deploy/status');
            renderDeployStatus(data);
            setPre('deploy-output', data);
        }

        function renderDeployStatus(data) {
            const badges = document.getElementById('deploy-badges');
            const runtime = document.getElementById('deploy-runtime');
            if (!badges || !runtime) return;
            const services = data?.services || {};
            const entries = Object.entries(services);
            badges.innerHTML = entries.map(([name, value]) => {
                const ok = String(value).toLowerCase() === 'online';
                const bg = ok ? '#dcfce7' : '#fef3c7';
                const fg = ok ? '#166534' : '#92400e';
                const dot = ok ? 'â—' : 'â—';
                return `<span style="padding:6px 10px; border-radius:999px; background:${bg}; color:${fg}; font-weight:600;">${dot} ${name}: ${value}</span>`;
            }).join('');
            const rt = data?.runtime || {};
            runtime.textContent = `Host: ${rt.host || '-'} | Port: ${rt.port || '-'} | Python: ${rt.python || '-'} | ENV: ${rt.flask_env || '-'} | Last deploy: ${data?.last_deploy || '-'}`;
        }

        async function uiAIStatus() {
            const { data } = await apiJson('/api/ai/status');
            setPre('doc-e2e-output', data);
        }

        async function uiAgentFeedback() {
            const expedienteId = Number(document.getElementById('feedback-expediente-id')?.value || '0');
            const contenido = document.getElementById('feedback-contenido')?.value || '';
            if (!expedienteId || !contenido.trim()) {
                return alert('Completa expediente_id y contenido');
            }
            const { data } = await apiJson('/api/agent/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    expediente_id: expedienteId,
                    contenido,
                    score: 1
                })
            });
            setPre('doc-e2e-output', data);
        }

        async function uiLoadJurisdictions() {
            const { data } = await apiJson('/api/business/jurisdictions');
            const sel = document.getElementById('bs-jurisdiction');
            if (sel && Array.isArray(data?.jurisdictions)) {
                sel.innerHTML = data.jurisdictions
                    .map(j => `<option value="${j.id}">${j.id} - ${j.name}</option>`)
                    .join('');
            }
            setPre('business-output', data);
        }

        async function uiLoadBusinessTemplates() {
            const jurisdiction = document.getElementById('bs-jurisdiction')?.value || 'ES_GENERAL';
            const { data } = await apiJson(`/api/business/templates?jurisdiction=${encodeURIComponent(jurisdiction)}`);
            const docTypeSel = document.getElementById('bs-doc-type');
            if (docTypeSel && Array.isArray(data?.templates) && data.templates.length) {
                docTypeSel.innerHTML = data.templates
                    .map(t => `<option value="${t.doc_type}">${t.doc_type} - ${t.title}</option>`)
                    .join('');
            }
            setPre('business-output', data);
        }

        async function uiBuildBusinessStrategy() {
            const jurisdiction = document.getElementById('bs-jurisdiction')?.value || 'ES_GENERAL';
            const query = document.getElementById('bs-query')?.value || '';
            const docType = document.getElementById('bs-doc-type')?.value || 'escrito_tramite';
            const fechaNotificacion = document.getElementById('bs-fecha-notificacion')?.value || '';
            const plazoDias = Number(document.getElementById('bs-plazo-dias')?.value || '0');
            const { data } = await apiJson('/api/business/strategy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jurisdiction,
                    doc_type: docType,
                    query,
                    fecha_notificacion: fechaNotificacion || undefined,
                    plazo_dias: plazoDias
                })
            });
            window.uiBusinessLastStrategy = data?.strategy || null;
            renderBusinessStructured(data);
            if (data?.success) {
                uiLoadBusinessHistory();
            }
            setPre('business-output', data);
        }

        async function uiExportBusinessStrategy(format) {
            if (!window.uiBusinessLastStrategy) {
                alert('Primero genera una estrategia.');
                return;
            }
            const client_name = (document.getElementById('bs-client-name')?.value || 'GENERAL').trim();
            const year = Number(document.getElementById('bs-year')?.value || new Date().getFullYear());
            const { data } = await apiJson('/api/business/strategy/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    strategy: window.uiBusinessLastStrategy,
                    format,
                    client_name,
                    year
                })
            });
            setPre('business-output', data);
        }

        async function uiLoadBusinessHistory() {
            const fromDate = document.getElementById('bs-history-from')?.value || '';
            const toDate = document.getElementById('bs-history-to')?.value || '';
            const userId = document.getElementById('bs-history-user')?.value || '';
            const params = new URLSearchParams({ limit: '50' });
            if (fromDate) params.set('from_date', fromDate);
            if (toDate) params.set('to_date', toDate);
            if (userId.trim()) params.set('user_id', userId.trim());
            const { data } = await apiJson(`/api/business/strategy/history?${params.toString()}`);
            renderBusinessHistory(data);
        }

        async function uiLoadPwaBusinessStatus() {
            const [overview, deploy] = await Promise.all([
                apiJson('/api/status/overview'),
                apiJson('/api/deploy/status')
            ]);
            const box = document.getElementById('pwa-status-badges');
            if (box) {
                const svc = overview?.data?.services || {};
                const deploySvc = deploy?.data?.services || {};
                const badges = [
                    { name: 'IA local', ok: !!svc.ia_local },
                    { name: 'SMTP', ok: !!svc.smtp },
                    { name: 'LexNET', ok: !!svc.lexnet },
                    { name: 'AutoProcessor', ok: !!svc.autoprocesor },
                    { name: 'PWA', ok: String(deploySvc.pwa || '').toLowerCase() === 'online' },
                ];
                box.innerHTML = badges.map(b => `
                    <span style="padding:4px 10px; border-radius:999px; font-size:13px; background:${b.ok ? '#dcfce7' : '#fee2e2'}; color:${b.ok ? '#166534' : '#991b1b'};">
                        ${b.ok ? 'â—' : 'â—‹'} ${b.name}
                    </span>
                `).join('');
            }
        }

        function renderBusinessStructured(data) {
            const wrap = document.getElementById('business-structured');
            if (!wrap) return;
            if (!data?.success || !data?.strategy) {
                wrap.innerHTML = '';
                return;
            }
            const s = data.strategy;
            const deadline = s.deadline || {};
            const deadlineText = deadline.dies_ad_quem || 'N/A';
            const critical = data?.deadline_critical;
            const steps = (s.recommended_steps || []).map(x => `<li>${x}</li>`).join('');
            wrap.innerHTML = `
                <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; background:#f8fafc;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; margin-bottom:8px;">
                        <div><strong>JurisdicciÃ³n:</strong> ${s.jurisdiction || '-'}</div>
                        <div><strong>Doc Type:</strong> ${s.doc_type || '-'}</div>
                        <div><strong>Deadline:</strong> ${deadlineText}</div>
                    </div>
                    <div style="margin-bottom:8px; color:${critical ? '#b91c1c' : '#166534'};">
                        <strong>Alerta:</strong> ${critical ? `CRITICA (${data?.deadline_days_left ?? 'N/A'} dias)` : 'Normal'}
                        ${critical ? ` | Email: ${data?.alert_sent ? 'enviado' : 'no enviado'}` : ''}
                    </div>
                    <div style="margin-bottom:8px;"><strong>Plantilla:</strong> ${(s.forensic_template || '').toString().substring(0, 180)}</div>
                    <div><strong>Pasos recomendados:</strong><ol style="margin:6px 0 0 18px;">${steps}</ol></div>
                </div>
            `;
        }

        function uiEsc(v) {
            return String(v ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderBusinessHistory(data) {
            const wrap = document.getElementById('business-history-wrap');
            if (!wrap) return;
            const items = Array.isArray(data?.items) ? data.items : [];
            window.uiBusinessHistoryItems = items;
            if (!items.length) {
                wrap.innerHTML = `<div style="padding:10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff;">Sin estrategias guardadas.</div>`;
                return;
            }
            const rows = items.map((i, idx) => `
                <tr>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${uiEsc(i.created_at)}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${uiEsc(i.user_id)}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${uiEsc(i.jurisdiction)}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${uiEsc(i.doc_type)}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${uiEsc(i.deadline_date || '-')}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0; color:${i.critical ? '#b91c1c' : '#166534'};">${i.critical ? 'CRITICA' : 'Normal'}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">
                        <button onclick="uiReuseBusinessStrategyByIndex(${idx})"
                            style="padding:4px 8px; background:#0f766e; color:#fff; border:none; border-radius:6px; cursor:pointer;">
                            Reusar
                        </button>
                    </td>
                </tr>
            `).join('');
            wrap.innerHTML = `
                <div style="border:1px solid #e2e8f0; border-radius:10px; background:#fff; overflow:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead style="background:#f1f5f9;">
                            <tr>
                                <th style="text-align:left; padding:8px;">Fecha</th>
                                <th style="text-align:left; padding:8px;">Usuario</th>
                                <th style="text-align:left; padding:8px;">Jurisdiccion</th>
                                <th style="text-align:left; padding:8px;">Tipo</th>
                                <th style="text-align:left; padding:8px;">Deadline</th>
                                <th style="text-align:left; padding:8px;">Criticidad</th>
                                <th style="text-align:left; padding:8px;">Accion</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function uiReuseBusinessStrategyByIndex(index) {
            const list = Array.isArray(window.uiBusinessHistoryItems) ? window.uiBusinessHistoryItems : [];
            const item = list[index];
            if (!item) {
                alert('No se encontro la estrategia en historial.');
                return;
            }
            const strategy = item?.strategy_json || null;
            const payload = item?.payload_json || {};
            if (!strategy) {
                alert('Esta fila no tiene estrategia reutilizable.');
                return;
            }
            window.uiBusinessLastStrategy = strategy;

            const jurisdictionSel = document.getElementById('bs-jurisdiction');
            if (jurisdictionSel && strategy.jurisdiction) jurisdictionSel.value = strategy.jurisdiction;
            const docTypeSel = document.getElementById('bs-doc-type');
            if (docTypeSel && strategy.doc_type) docTypeSel.value = strategy.doc_type;
            const queryInput = document.getElementById('bs-query');
            if (queryInput) queryInput.value = payload.query || item.query || '';

            if (payload.fecha_notificacion) {
                const f = document.getElementById('bs-fecha-notificacion');
                if (f) f.value = payload.fecha_notificacion;
            }
            if (payload.plazo_dias !== undefined) {
                const p = document.getElementById('bs-plazo-dias');
                if (p) p.value = String(payload.plazo_dias);
            }

            renderBusinessStructured({
                success: true,
                strategy,
                deadline_critical: !!item.critical
            });
            setPre('business-output', { success: true, reused_from_history_id: item.id, strategy, payload });
        }

    
        // (definiciÃ³n legacy de loadProcessingLog eliminada; usar la versiÃ³n con filtros)
        
        function showFilePaths(filename, backup, final) {
            alert('ğŸ“‚ Trazabilidad de: ' + filename + '\n\n' +
                  'ğŸ’¾ Backup:\n' + backup + '\n\n' +
                  'âœ… Final:\n' + final);
        }
        
        // Cargar log cuando se abre el tab
        const origShowTab3 = window.showTab;
        window.showTab = function(tab) {
            origShowTab3(tab);
            if (tab === 'autoprocesos') {
                loadAutoProcessorStatus();
                loadProcessingLog();
            }
            if (tab === 'pdf-preview') {
                uiLoadFiles();
            }
            if (tab === 'email-alerts') {
                uiAlertsStatus();
            }
            if (tab === 'usuarios') {
                uiLoadUsuarios();
            }
            if (tab === 'pwa') {
                uiLoadPwaBusinessStatus();
                uiLoadJurisdictions();
                uiLoadBusinessHistory();
            }
            if (tab === 'ia-agent') {
                uiLoadAIProvidersLegacy();
            }
            if (tab === 'analytics') {
                uiLoadAnalytics();
            }
            if (tab === 'expedientes') {
                uiLoadExpedientes();
                uiIcloudStatus();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            maybeShowFirstRun();
        });

    </script>

</body>
</html>
