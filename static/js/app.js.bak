// ============================================
// ESTADO GLOBAL
// ============================================
let currentFile = null;
let ocrText = '';
let availableProviders = [];
let currentDocType = null;
let generatedDocContent = '';

// ============================================
// INICIALIZACI√ìN
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    // Inicializar tab de consultas
    refreshFiles();
    loadAIProviders();
    addMessage('system', '¬°Bienvenido a LexDocsPro LITE v2.0! Ahora con m√∫ltiples IAs y generaci√≥n de documentos.');
    
    // Inicializar generador de documentos
    loadDocumentTemplates();
    
    // Event listener para Enter en chat
    const promptInput = document.getElementById('chatPrompt');
    if (promptInput) {
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
});

// ============================================
// GESTI√ìN DE TABS
// ============================================
function switchTab(tabName) {
    // Desactivar todos los tabs
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Activar tab seleccionado
    event.target.classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    updateStatus(`Pesta√±a: ${tabName === 'consulta' ? 'Consultas' : 'Generador de Documentos'}`);
}

// ============================================
// PROVEEDORES DE IA
// ============================================
async function loadAIProviders() {
    try {
        const response = await fetch('/api/ai/providers');
        const data = await response.json();
        
        availableProviders = data.providers;
        const select = document.getElementById('aiProvider');
        const docSelect = document.getElementById('docProvider');
        
        select.innerHTML = '';
        docSelect.innerHTML = '';
        
        const providerNames = {
            'ollama': 'üè† Ollama (Local)',
            'groq': '‚ö° Groq (Ultra R√°pido)',
            'openai': 'ü§ñ ChatGPT (OpenAI)',
            'perplexity': 'üîç Perplexity',
            'gemini': 'üíé Gemini (Google)',
            'deepseek': 'üåä DeepSeek'
        };
        
        availableProviders.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider;
            option.textContent = providerNames[provider] || provider;
            if (provider === data.default) {
                option.selected = true;
            }
            select.appendChild(option);
            
            const option2 = option.cloneNode(true);
            docSelect.appendChild(option2);
        });
        
        if (availableProviders.length > 0) {
            addMessage('system', `‚úÖ Proveedores disponibles: ${availableProviders.map(p => providerNames[p]).join(', ')}`);
        }
        
    } catch (error) {
        console.error('Error loading providers:', error);
        addMessage('system', '‚ö†Ô∏è No se pudieron cargar los proveedores de IA');
    }
}

// ============================================
// EXPLORADOR DE ARCHIVOS
// ============================================
async function refreshFiles(path = '') {
    try {
        updateStatus('Cargando archivos...');
        const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
        const data = await response.json();
        renderFileTree(data);
        updateStatus('Listo');
    } catch (error) {
        console.error('Error:', error);
        updateStatus('‚ùå Error al cargar archivos');
    }
}

function renderFileTree(data) {
    const tree = document.getElementById('fileTree');
    const pathDiv = document.getElementById('currentPath');
    
    pathDiv.textContent = data.current_path || 'Ra√≠z';
    tree.innerHTML = '';
    
    if (data.current_path) {
        const upBtn = document.createElement('div');
        upBtn.className = 'folder';
        upBtn.textContent = 'üìÅ .. (Subir)';
        upBtn.onclick = () => {
            const parent = data.current_path.split('/').slice(0, -1).join('/');
            refreshFiles(parent);
        };
        tree.appendChild(upBtn);
    }
    
    data.folders.forEach(folder => {
        const div = document.createElement('div');
        div.className = 'folder';
        div.textContent = `üìÅ ${folder.name}`;
        div.onclick = () => refreshFiles(folder.path);
        tree.appendChild(div);
    });
    
    data.files.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file';
        div.textContent = `üìÑ ${file.name}`;
        div.onclick = () => selectFile(file);
        tree.appendChild(div);
    });
    
    if (data.folders.length === 0 && data.files.length === 0) {
        tree.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">Carpeta vac√≠a</p>';
    }
}

function selectFile(file) {
    currentFile = file;
    document.querySelectorAll('.file').forEach(el => el.classList.remove('selected'));
    event.target.classList.add('selected');
    loadPDF(file.path);
    updateStatus(`Archivo: ${file.name}`);
}

function loadPDF(path) {
    const viewer = document.getElementById('pdfViewer');
    const btnOCR = document.getElementById('btnOCR');
    viewer.innerHTML = `<iframe src="/api/pdf/${encodeURIComponent(path)}"></iframe>`;
    btnOCR.disabled = false;
    ocrText = '';
}

// ============================================
// OCR
// ============================================
async function runOCR() {
    if (!currentFile) return;
    
    try {
        updateStatus('üîç Ejecutando OCR...');
        const btnOCR = document.getElementById('btnOCR');
        btnOCR.disabled = true;
        btnOCR.innerHTML = '<span class="loading"></span> Procesando...';
        
        const response = await fetch('/api/ocr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: currentFile.path })
        });
        
        const data = await response.json();
        
        if (data.text) {
            ocrText = data.text;
            addMessage('system', `‚úÖ OCR completado: ${data.text.length} caracteres extra√≠dos`);
            addMessage('assistant', `He procesado "${currentFile.name}". Puedes hacerme preguntas sobre el contenido.`);
            updateStatus('‚úÖ OCR completado');
        } else {
            addMessage('system', '‚ö†Ô∏è No se pudo extraer texto del documento');
            updateStatus('‚ö†Ô∏è OCR sin resultados');
        }
        
    } catch (error) {
        console.error('Error:', error);
        addMessage('system', '‚ùå Error al ejecutar OCR');
        updateStatus('‚ùå Error en OCR');
    } finally {
        const btnOCR = document.getElementById('btnOCR');
        btnOCR.disabled = false;
        btnOCR.textContent = 'üîç Ejecutar OCR';
    }
}

// ============================================
// CHAT CON IA
// ============================================
async function sendMessage() {
    const promptInput = document.getElementById('chatPrompt');
    const prompt = promptInput.value.trim();
    
    if (!prompt) return;
    
    const provider = document.getElementById('aiProvider').value;
    const mode = document.getElementById('aiMode').value;
    
    // Mostrar mensaje del usuario
    addMessage('user', prompt);
    promptInput.value = '';
    
    // Indicador de modo
    const modeNames = {
        'standard': '‚ö° R√°pida',
        'deep': 'üîç Profunda',
        'research': 'üìö Investigaci√≥n'
    };
    
    // Mostrar indicador de carga
    const loadingId = addMessage('assistant', `<span class="loading"></span> ${modeNames[mode]} con ${provider}...`);
    updateStatus(`üí¨ Consultando ${provider} (${modeNames[mode]})...`);
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt,
                context: ocrText,
                provider: provider,
                mode: mode
            })
        });
        
        const data = await response.json();
        
        // Reemplazar mensaje de carga
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) {
            if (data.success) {
                loadingMsg.innerHTML = data.response;
            } else {
                loadingMsg.innerHTML = `‚ùå Error: ${data.error}`;
                loadingMsg.classList.add('error');
            }
        }
        
        updateStatus('Listo');
        
    } catch (error) {
        console.error('Error:', error);
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) {
            loadingMsg.textContent = '‚ùå Error al conectar con IA';
        }
        updateStatus('‚ùå Error en chat');
    }
}

function addMessage(type, text) {
    const container = document.getElementById('chatMessages');
    const msgId = 'msg-' + Date.now();
    
    const div = document.createElement('div');
    div.id = msgId;
    div.className = `message ${type}`;
    div.innerHTML = text;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return msgId;
}

// ============================================
// GENERADOR DE DOCUMENTOS
// ============================================
async function loadDocumentTemplates() {
    try {
        const response = await fetch('/api/documents/templates');
        const templates = await response.json();
        
        const container = document.getElementById('docTypes');
        container.innerHTML = '';
        
        Object.entries(templates).forEach(([type, template]) => {
            const btn = document.createElement('button');
            btn.className = 'doc-type-btn';
            btn.onclick = () => selectDocType(type, template);
            btn.innerHTML = `
                <strong>${template.name}</strong>
                <small>${template.description}</small>
            `;
            container.appendChild(btn);
        });
        
    } catch (error) {
        console.error('Error loading templates:', error);
    }
}

function selectDocType(type, template) {
    currentDocType = type;
    
    // Actualizar botones
    document.querySelectorAll('.doc-type-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Mostrar formulario
    document.getElementById('docFormTitle').textContent = template.name;
    document.getElementById('docFormDesc').textContent = template.description;
    document.getElementById('documentForm').classList.remove('hidden');
    document.getElementById('generatedDoc').classList.add('hidden');
    
    // Generar campos del formulario
    const fieldsContainer = document.getElementById('formFields');
    fieldsContainer.innerHTML = '';
    
    template.fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'form-group';
        
        const label = document.createElement('label');
        label.textContent = field.label;
        group.appendChild(label);
        
        let input;
        if (field.type === 'textarea') {
            input = document.createElement('textarea');
            input.rows = 4;
        } else if (field.type === 'select') {
            input = document.createElement('select');
            field.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                input.appendChild(option);
            });
        } else {
            input = document.createElement('input');
            input.type = field.type;
        }
        
        input.name = field.name;
        input.id = `field-${field.name}`;
        group.appendChild(input);
        
        fieldsContainer.appendChild(group);
    });
}

async function generateDocument() {
    if (!currentDocType) return;
    
    // Recoger datos del formulario
    const formData = {};
    document.querySelectorAll('#formFields input, #formFields textarea, #formFields select').forEach(field => {
        formData[field.name] = field.value;
    });
    
    const provider = document.getElementById('docProvider').value;
    
    updateStatus('‚ú® Generando documento profesional...');
    
    try {
        const response = await fetch('/api/documents/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: currentDocType,
                data: formData,
                provider: provider
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            generatedDocContent = result.content;
            
            // Mostrar documento generado
            document.getElementById('documentForm').classList.add('hidden');
            document.getElementById('generatedDoc').classList.remove('hidden');
            document.getElementById('docContent').textContent = result.content;
            
            updateStatus(`‚úÖ Documento generado: ${result.filename}`);
        } else {
            alert(`Error: ${result.error}`);
            updateStatus('‚ùå Error al generar documento');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al generar el documento');
        updateStatus('‚ùå Error en generaci√≥n');
    }
}

function copyDocument() {
    const content = document.getElementById('docContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        updateStatus('‚úÖ Documento copiado al portapapeles');
    });
}

function downloadDocument() {
    const content = document.getElementById('docContent').textContent;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentDocType}_${new Date().getTime()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    updateStatus('‚úÖ Documento descargado');
}

function resetGenerator() {
    document.getElementById('documentForm').classList.remove('hidden');
    document.getElementById('generatedDoc').classList.add('hidden');
    document.getElementById('formFields').querySelectorAll('input, textarea').forEach(field => {
        field.value = '';
    });
    updateStatus('Listo para nuevo documento');
}

// ============================================
// UTILIDADES
// ============================================
function updateStatus(text) {
    document.getElementById('status').textContent = text;
}

// ============================================
// ANALIZADOR LEXNET
// ============================================
let lexnetFiles = {
    resumen: null,
    caratula: null,
    principal: null
};

let lexnetTexts = {
    resumen: '',
    caratula: '',
    principal: ''
};

let currentAnalysis = '';

function handleFileUpload(type) {
    const fileInput = document.getElementById(`file${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const statusSpan = document.getElementById(`status${type.charAt(0).toUpperCase() + type.slice(1)}`);
    
    const file = fileInput.files[0];
    if (file) {
        lexnetFiles[type] = file;
        statusSpan.textContent = file.name;
        statusSpan.classList.add('uploaded');
        
        updateStatus(`üìÑ ${file.name} cargado`);
        
        // Verificar si se pueden habilitar los botones
        checkLexNetReady();
    }
}

function checkLexNetReady() {
    const btnAnalyze = document.getElementById('btnAnalyze');
    
    // Requerir al menos resumen y principal
    if (lexnetFiles.resumen && lexnetFiles.principal) {
        btnAnalyze.disabled = false;
    } else {
        btnAnalyze.disabled = true;
    }
}

async function analyzeLexNet() {
    const provider = document.getElementById('lexnetProvider').value;
    const btnAnalyze = document.getElementById('btnAnalyze');
    
    btnAnalyze.disabled = true;
    btnAnalyze.innerHTML = '<span class="loading"></span> Analizando...';
    
    updateStatus('üîç Extrayendo texto con OCR...');
    
    try {
        // 1. Extraer texto de cada PDF con OCR
        const progressDiv = document.createElement('div');
        progressDiv.className = 'ocr-progress';
        progressDiv.innerHTML = `
            <div class="ocr-progress-item" id="progress-resumen">
                <div class="spinner"></div> Procesando RESUMEN.pdf...
            </div>
            <div class="ocr-progress-item" id="progress-caratula">
                <div class="spinner"></div> Procesando CARATULA.pdf...
            </div>
            <div class="ocr-progress-item" id="progress-principal">
                <div class="spinner"></div> Procesando resoluci√≥n principal...
            </div>
        `;
        
        document.querySelector('.lexnet-upload').appendChild(progressDiv);
        
        // OCR RESUMEN
        if (lexnetFiles.resumen) {
            lexnetTexts.resumen = await extractTextFromFile(lexnetFiles.resumen);
            updateProgressItem('resumen', lexnetTexts.resumen ? 'done' : 'error');
        }
        
        // OCR CARATULA
        if (lexnetFiles.caratula) {
            lexnetTexts.caratula = await extractTextFromFile(lexnetFiles.caratula);
            updateProgressItem('caratula', lexnetTexts.caratula ? 'done' : 'error');
        }
        
        // OCR PRINCIPAL
        if (lexnetFiles.principal) {
            lexnetTexts.principal = await extractTextFromFile(lexnetFiles.principal);
            updateProgressItem('principal', lexnetTexts.principal ? 'done' : 'error');
        }
        
        updateStatus('ü§ñ Analizando con IA...');
        
        // 2. Enviar a analizar
        const response = await fetch('/api/lexnet/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                textos: lexnetTexts,
                provider: provider
            })
        });
        
        const result = await response.json();
        
        progressDiv.remove();
        
        if (result.success) {
            currentAnalysis = result.analisis;
            
            // Mostrar an√°lisis
            document.getElementById('lexnetContent').textContent = result.analisis;
            document.getElementById('lexnetActions').classList.remove('hidden');
            
            updateStatus(`‚úÖ An√°lisis completado: ${result.filename}`);
        } else {
            alert(`Error: ${result.error}`);
            updateStatus('‚ùå Error en an√°lisis');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al analizar la notificaci√≥n');
        updateStatus('‚ùå Error en an√°lisis');
    } finally {
        btnAnalyze.disabled = false;
        btnAnalyze.textContent = 'üîç Analizar Notificaci√≥n';
    }
}

async function extractTextFromFile(file) {
    try {
        // Crear FormData y subir archivo temporalmente
        const formData = new FormData();
        formData.append('file', file);
        
        // Aqu√≠ deber√≠amos implementar un endpoint para OCR directo
        // Por ahora simulamos con un placeholder
        return `Contenido extra√≠do de ${file.name}`;
        
    } catch (error) {
        console.error('Error extrayendo texto:', error);
        return '';
    }
}

function updateProgressItem(type, status) {
    const item = document.getElementById(`progress-${type}`);
    if (item) {
        if (status === 'done') {
            item.innerHTML = '‚úÖ Completado';
            item.classList.add('done');
        } else if (status === 'error') {
            item.innerHTML = '‚ùå Error';
            item.classList.add('error');
        }
    }
}

function copyLexNetAnalysis() {
    navigator.clipboard.writeText(currentAnalysis).then(() => {
        updateStatus('‚úÖ An√°lisis copiado al portapapeles');
    });
}

function downloadLexNetAnalysis() {
    const blob = new Blob([currentAnalysis], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis_lexnet_${new Date().getTime()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    updateStatus('‚úÖ An√°lisis descargado');
}

function resetLexNet() {
    // Reset files
    lexnetFiles = { resumen: null, caratula: null, principal: null };
    lexnetTexts = { resumen: '', caratula: '', principal: '' };
    currentAnalysis = '';
    
    // Reset UI
    document.getElementById('fileResumen').value = '';
    document.getElementById('fileCaratula').value = '';
    document.getElementById('filePrincipal').value = '';
    
    document.getElementById('statusResumen').textContent = 'Ning√∫n archivo';
    document.getElementById('statusCaratula').textContent = 'Ning√∫n archivo';
    document.getElementById('statusPrincipal').textContent = 'Ning√∫n archivo';
    
    document.getElementById('statusResumen').classList.remove('uploaded');
    document.getElementById('statusCaratula').classList.remove('uploaded');
    document.getElementById('statusPrincipal').classList.remove('uploaded');
    
    document.getElementById('lexnetContent').innerHTML = '<p class="placeholder">Sube los archivos y presiona "Analizar Notificaci√≥n" para comenzar</p>';
    document.getElementById('lexnetActions').classList.add('hidden');
    
    checkLexNetReady();
    updateStatus('Listo para nuevo an√°lisis');
}
